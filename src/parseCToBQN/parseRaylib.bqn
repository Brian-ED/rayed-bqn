## Metaprogram rayffi.bqn automatically.

ffiUtilsPathâ†âŠ‘â€¢argsâˆ¾<"../ffiUtils.bqn"

# util functions
nl â† @+10 # newline
Box â†  >âŠ¢Â»Â¨âŸœ<' 'â¥ŠËœÂ·âŒˆÂ´â‰ Â¨
LowerNames â† +âŸœ(32Ã—1="A["âŠ¸â‹)âŒ¾(1â†‘âŠ¢)
_MetaParse â† {âˆ¾Ë˜Â´(â‰>ğ•—â€¿ğ•¨){Fâ€¿wğ•Šğ•©:<wâŠ¸âˆ¾Ë˜Box Fğ•©}Ë˜â‰ğ•©}
SHErr â† {exitcodeâ€¿stdoutâ€¿stderrâ†â€¢SHğ•©
  â€¢Out stdout
  stderr!0=exitcode
}

# imports
âŸ¨raylibPathâŸ© â† â€¢Import"../loadConfig.bqn"
json â† â€¢Import "../imports/bqn-libs/json.bqn"

# getting raylib.h path
raylibHeaderPath â† "include/raylib.h"âˆ¾Ëœ"lib/"âˆ¾Ëœâ¼{ğ•©â†“Ëœ-âŠ‘âŠâŸœ1âŒ½'/'=ğ•©}raylibPath
(â€¢file.Exists raylibHeaderPath)!Ëœ"raylib header file expected at "âˆ¾raylibHeaderPath

# compile c parser if non existant

SHErr "cc"â€¿"raylib_parser.c"
SHErr "./a.out"â€¿"-i"â€¿raylibHeaderPathâ€¿"-f"â€¿"JSON"â€¿"-o"â€¿"raylib.json"

#raygui:
#cc raylib_parser.c && ./a.out -i ./inp-out/raygui.c -f JSON -o ./inp-out/raygui.json && rm ./a.out
#raylib: 
#cc raylib_parser.c && ./a.out -i ./inp-out/raylib.h -f JSON -o raylib.json && rm ./a.out

mapArgTypes â† {ğ•Š[bqn,c]:{ğ•©LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠğ•©)âŠbqnâˆ¾<0}6â†“âŸ("const "â‰¡â†‘)Â¨âŠ¢} abcâ†â‰[  
  # pointers
  "'*'âˆ¾boneInfo"      â€¿"boneInfo *"
  "'*'âˆ¾camera3D"      â€¿"Camera *"
  "'*'âˆ¾color"         â€¿"Color *"
  "'*'âˆ¾glyphInfo"     â€¿"GlyphInfo *"
  "'*'âˆ¾image"         â€¿"Image *"
  "'*'âˆ¾material"      â€¿"Material *"
  "'*'âˆ¾materialMap"   â€¿"materialMap *"
  "'*'âˆ¾matrix"        â€¿"Matrix *"
  "'*'âˆ¾mesh"          â€¿"Mesh *"
  "'*'âˆ¾model"         â€¿"Model *"
  "'*'âˆ¾modelAnimation"â€¿"ModelAnimation *"
  "'*'âˆ¾rectangle"     â€¿"rectangle *"
  "'*'âˆ¾texture"       â€¿"Texture2D *"
  "'*'âˆ¾transform"     â€¿"transform *"
  "'*'âˆ¾v2"            â€¿"Vector2 *"
  "'*'âˆ¾v3"            â€¿"Vector3 *"
  "'*'âˆ¾v4"            â€¿"Vector4 *"
  "'*'âˆ¾wave"          â€¿"Wave *"
  """**""âˆ¾rectangle"  â€¿"Rectangle **"
  """**""âˆ¾transform"  â€¿"transform **"

  # remove since they're not defined
  "ptr"â€¿"AudioCallback"
  "ptr"â€¿"LoadFileDataCallback"
  "ptr"â€¿"LoadFileTextCallback"
  "ptr"â€¿"rAudioBuffer *"
  "ptr"â€¿"rAudioProcessor *"
  "ptr"â€¿"SaveFileDataCallback"
  "ptr"â€¿"SaveFileTextCallback"
  "ptr"â€¿"TraceLogCallback"

  # shorten struct names
  "camera3D"     â€¿"Camera"
  "renderTexture"â€¿"RenderTexture2D"
  "texture"      â€¿"Texture2D"
  "texture"      â€¿"textureCubemap"
  "v2"           â€¿"Vector2"
  "v3"           â€¿"Vector3"
  "v4"           â€¿"Vector4"

  "'*'âˆ¾f"   â€¿"float *"
  "'*'âˆ¾i"   â€¿"int *"
  "'*'âˆ¾str" â€¿"char **"
  "'*'âˆ¾u"   â€¿"unsigned int *"
  """*i16"""â€¿"unsigned short *"
  """f64""" â€¿"double"
  """i64""" â€¿"long"
  "f"       â€¿"float"
  "i"       â€¿"int"
  "ptr"     â€¿"..."
  "ptr"     â€¿"void *"
  "str"     â€¿"char *"
  "u"       â€¿"unsigned int"
  "u8"      â€¿"char"
  "u8"      â€¿"unsigned char"
  "ustr"    â€¿"unsigned char *"
]

mapStructTypes â† {ğ•Š[bqn,c]:{ğ•©âŠ£âŸ(0âŠ¸â‰¡)Â¨((LowerNamesÂ¨c)âŠğ•©)âŠbqnâˆ¾0}{
  b â† (âŠ‘âˆ˜âŠÂ¨âŸœ'['-â‰ Â¨)ğ•©
  "ptrâŠ£"âŠ¸âˆ¾âŸ(('*'â‰¡1âŠ‘2â†‘âŠ¢)âˆ¨("ustr"â‰¡4â†‘âŠ¢)âˆ¨"str"â‰¡3â†‘âŠ¢)Â¨ 3âŠ¸â†“Â¨âŒ¾((0=b)âŠ¸/) ğ”½{'"'âˆ¾Â¨(bâ†‘Â¨ğ•©)âˆ¾Â¨"""âˆ¾"âŠ¸âˆ¾Â¨ğ”½ bâ†“Â¨ğ•©} LowerNamesÂ¨ğ•©
}6â†“âŸ("const "â‰¡â†‘)Â¨âŠ¢}abc

mapStructNames â† {ğ•Š[bqn,c]:{ğ•©LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠğ•©)âŠbqnâˆ¾<0}6â†“âŸ("const "â‰¡â†‘)Â¨âŠ¢}â‰[  
  "v4"â€¿"Vector4"
  "v3"â€¿"Vector3"
  "v2"â€¿"Vector2"
]

_Time â† {â€¢Show ğ”½â€¢_timedğ•©â‹„ğ”½ğ•©}
MapFuncReturnType â† " "âŸ("void"âŠ¸â‰¡)Â¨Â·{'('âˆ¾ğ•©âˆ¾')'}âŸ(âˆ¨Â´"âˆ¾âŠ£"âŠ¸âˆŠ)Â¨MapStructTypes

definesâ€¿structsâ€¿aliasesâ€¿enumsâ€¿callbacksâ€¿functionsâ†{
  xâ†â‰json.Parse â€¢FChars "raylib.json"
  !(âŠË˜x)â‰¡"defines"â€¿"structs"â€¿"aliases"â€¿"enums"â€¿"callbacks"â€¿"functions"
  1âŠË˜x
}
{ğ•Šğ•©: 
  â¥Šnlâˆ¾Ë˜""â€¿" â‡ "â€¿" # "âŸ¨LowerNames,LowerNames,âŠ¢âŸ©_MetaParse 1â€¿0â€¿2âŠ¸âŠË˜>1âŠÂ¨ğ•©
}aliases

"./inp-out/rayffi.bqn"â€¢FLines (â€¢FLines "topOfRayffi.bqn") âˆ¾(â‹ˆ"r â‡ MakeImporter """âˆ¾raylibPathâˆ¾'"')âˆ¾âˆ¾Â´âŸ¨
  { # defines
    Parse â† {âˆ¾Ë˜Â´BoxÂ¨""â€¿""â€¿" â‡ "â€¿" # "âˆ¾âŸ(âŸ¨âŸ©â‰¢âŠ¢)âš‡1âŸ¨LowerNames,âŸ¨âŸ©Ë™,â€¢Repr,âŠ¢âŸ©{ğ•ğ•©}Â¨Â¨ <Ë˜â‰ğ•©}
    exclTypes  â† "GUARD"â€¿"MACRO"â€¿"UNKNOWN"â€¿"FLOAT_MATH"â€¿"COLOR"
    Filter     â† {ğ•Šnâ€¿tâ€¿vâ€¿d: # nameâ€¿typeâ€¿valâ€¿desc
      Â¬âˆ¨Â´âŸ¨"PI"â‰¡n, âˆ¨Â´tâŠ¸â‰¡Â¨exclTypes, âŸ¨âŸ©â‰¡v âŸ©
    }
    <Ë˜Parse FilterË˜âŠ¸/ 1âŠË˜Ë˜ >â‰Â¨defines
  }
  { # structs
    ParseStruct â† {
      âˆ¾(@+10)âˆ¾Â¨"âŸ©"âˆ¾Ëœ<Ë˜"  "âˆ¾â‰1""â€¿" # "â€¿"  # "âŸ¨âŠ¢, âŠ¢,âŠ¢âŸ©_MetaParse MapStructTypesâŒ¾(âŠË˜) >ğ•©
    }
    Parse â† { # ğ•Š â‰[name,desc,fields]:
      header â† (Â»âŠ¸âˆ¨' 'âŠ¸â‰ )âŠ¸/Â¨<Ë˜""â€¿" â‡ S âŸ¨ # "âŸ¨LowerNamesÂ¨,âŠ¢âŸ©_MetaParse MapStructNamesâŒ¾(âŠË˜) 2â†‘Ë˜ğ•©
      body â† âˆ¨`âŒ¾âŒ½âˆ˜â‰ âŸœ' 'âŠ¸/Â¨<Ë˜âŸ¨""âŸ©âŸ¨ParseStructÂ¨ 1âŠÂ¨Â¨âŠ¢âŸ©_MetaParse Â¯1â†‘Ë˜3â†‘Ë˜ğ•©
      body âˆ¾ËœÂ¨header
    }âŒ½âŒ¾(1â†“âŠ¢)Ë˜âŒ¾â‰
    Parse 1âŠË˜Ë˜>â‰Â¨âŒ½structs
  }
  { # enums
    ParseNamespaceâ†{ğ•Šnameâ€¿descriptionâ€¿values:
      header â† (LowerNames name)âˆ¾" â‡ { # "âˆ¾description
      body   â† ""â€¿" â‡ "â€¿"  # "âŸ¨LowerNamesÂ¨,â€¢ReprÂ¨,âŠ¢âŸ©_MetaParse >1âŠÂ¨values
      (nlâˆ¾"}")âˆ¾Ëœheaderâˆ¾âˆ¾(nlâˆ¾"  ")âŠ¸âˆ¾Â¨<Ë˜body
    }
    ParseNamespaceÂ¨âŠ¢ËÂ¨enums
  }
  { # functions
    # â‰[name, description, returnType, params]:
    <Ë˜""â€¿" â‡ "â€¿""""â€¿" _RâŸ¨"â€¿"#"â€¿" # "âŸ¨
      LowerNamesÂ¨ â‹„ MapFuncReturnType â‹„ âˆ¾âŸœ'"'Â¨ â‹„ ('âŸ©'âˆ¾Ëœ1â†“Â·âˆ¾'â‹„'âˆ¾Â¨MapArgTypes)Â¨ â‹„ (âˆ¾' 'âŠ¸âˆ¾Â¨)Â¨ â‹„ âŠ¢
    âŸ©_MetaParse{
      0â€¿2â€¿0â€¿3â€¿4â€¿1âŠ(3â†‘ğ•©)âˆ¾â‰{<Ë˜â‰âˆ˜â€¿2â¥ŠâŠ¢ËË˜>âŠ‘ğ•©}Ë˜âŠ¢Ëğ•©
    }âŒ¾â‰>âˆ¾âŸœ(<âŸ¨âŸ©)âŸ(3=â‰ )Â¨âŠ¢ËÂ¨functions
  }
âŸ©

â€¢file.RemoveÂ¨ "a.out"â€¿"raylib.json"
