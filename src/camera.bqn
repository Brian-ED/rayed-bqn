# rcamera - Basic camera system with support for multiple camera modes

âŸ¨
  GetCameraForward
  GetCameraUp
  GetCameraRight

  # Camera movement
  CameraMoveForward
  CameraMoveUp
  CameraMoveRight
  CameraMoveToTarget

  # Camera rotation
  CameraYaw
  CameraPitch
  CameraRoll

  GetCameraViewMatrix
  GetCameraProjectionMatrix
  CustomGetCameraProjectionMatrix

  UpdateCamera

  cameraMode
  cameraProjection
  cameraIndex
âŸ©â‡

keyâ€¿mouseâ€¿raylibâ€¿raymath â† â€¢args

âŸ¨
  up, left, down, right
  w, a, s, d, e, q
  space, left_control, IsPressed, keypad,
  IsDown
âŸ© â† key

âŸ¨
  GetFrameTime
  gamepadAxis
  GetGamepadAxisMovement
  IsGamepadAvailable
âŸ© â† raylib
âŸ¨
  Vector3RotateByAxisAngle
  VectorAngle
  MatrixLookAt
  MatrixPerspective
  MatrixOrtho
  deg2rad
  MP
  MatrixRotate
âŸ© â† raymath

cameraMode â† { # Camera system modes
  cAMERA_CUSTOM       â‡ 0  # Custom camera
  cAMERA_FREE         â‡ 1  # Free camera
  cAMERA_ORBITAL      â‡ 2  # Orbital camera
  cAMERA_FIRST_PERSON â‡ 3  # First person camera
  cAMERA_THIRD_PERSON â‡ 4  # Third person camera
}

cameraProjection â‡ { # Camera projection
  cAMERA_PERSPECTIVE  â‡ 0  # Perspective projection
  cAMERA_ORTHOGRAPHIC â‡ 1  # Orthographic projection
}

cameraIndex â‡ {
  position   â‡ 0 # Camera position
  target     â‡ 1 # Camera target it looks-at
  up         â‡ 2 # Camera up vector (rotation over its axis)
  fovy       â‡ 3 # Camera field-of-view aperture in Y (degrees) in perspective, used as near plane width in orthographic
  projection â‡ 4 # Camera projection: CAMERA_PERSPECTIVE or CAMERA_ORTHOGRAPHIC
}


#----------------------------------------------------------------------------------
# Module Functions Definition
#----------------------------------------------------------------------------------
# Returns the cameras forward vector (normalized)
GetCameraForward â† {ğ•Šcamera:
  Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ))-Â´cameraIndex.targetâ€¿cameraIndex.positionâŠcamera
}

# Returns the cameras up vector (normalized)
# Note: The up vector might not be perpendicular to the forward vector
GetCameraUp â† {ğ•Šcamera:
  Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ)) cameraIndex.upâŠ‘camera
}

# Returns the cameras right vector (normalized)
GetCameraRight â† {ğ•Šcamera:
  (GetCameraForward camera) 1âŠ¸âŒ½âŠ¸Ã—{1âŒ½ğ”½Ëœ-ğ”½} GetCameraUp camera
}

# Moves the camera in its forward direction
CameraMoveForward â† {distanceğ•Šcamera:

  forward â† GetCameraForward camera

  # Move position and target
  (forwardÃ—distance)âŠ¸+Â¨âŒ¾(cameraIndex.positionâ€¿cameraIndex.targetâŠ¸âŠ) camera
}

# Moves the camera in its forward direction
CameraMoveForwardInWorldPlane â† {distanceğ•Šcamera:

  # Project vector onto world plane
  forward â† Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ)) 0âŒ¾(1âŠ¸âŠ‘) GetCameraForward camera

  # Move position and target
  (forwardÃ—distance)âŠ¸+Â¨âŒ¾(cameraIndex.positionâ€¿cameraIndex.targetâŠ¸âŠ) camera
}

# Moves the camera in its up direction
CameraMoveUp â† {distanceğ•Šcamera:
  (distanceÃ—GetCameraUp camera)âŠ¸+Â¨âŒ¾(cameraIndex.positionâ€¿cameraIndex.targetâŠ¸âŠ)camera
}

# Moves the camera target in its current right direction
CameraMoveRight â† {distanceğ•Šcamera:
  right â† GetCameraRight camera

  # Scale by distance
  (rightÃ—distance)âŠ¸+Â¨âŒ¾(cameraIndex.positionâ€¿cameraIndex.targetâŠ¸âŠ)camera
}

# Moves the camera target in its current right direction
CameraMoveRightInWorldPlane â† {distanceğ•Šcamera:
  # Project vector onto world plane
  right â† Ã·âŸœ(0âŠ¸=âŠ¸++Â´âŒ¾(Ã—Ëœ)) 0âŒ¾(1âŠ¸âŠ‘) GetCameraRight camera

  # Scale by distance
  (rightÃ—distance)âŠ¸+Â¨âŒ¾(cameraIndex.positionâ€¿cameraIndex.targetâŠ¸âŠ)camera
}

# Moves the camera position closer/farther to/from the camera target
CameraMoveToTarget â† {deltağ•Šcamera:
  distance â† delta++Â´âŒ¾(Ã—Ëœ)-Â´cameraIndex.positionâ€¿cameraIndex.targetâŠcamera

  # Set new distance by moving the position along the forward vector
  forward â† distanceÃ—GetCameraForward camera
  (forward -Ëœ cameraIndex.targetâŠ‘camera)âŒ¾(cameraIndex.positionâŠ¸âŠ‘)camera
}

# Rotates the camera around its up vector
# Yaw is "looking left and right"
# If rotateAroundTarget is false, the camera rotates around its position
# Note: angle must be provided in radians
CameraYaw â† {angleâ€¿rotateAroundTargetğ•Šcamera:
  up â† GetCameraUp camera # Rotation axis

  # View vector
  targetPosition â† -Â´cameraIndex.targetâ€¿cameraIndex.positionâŠcamera

  # Rotate view vector around up axis
  targetPosition Vector3RotateByAxisAngleËœâ†©upâ€¿angle

  {rotateAroundTarget?
    # Move position relative to target
    (targetPosition -Ëœ cameraIndex.targetâŠ‘camera)âŒ¾(cameraIndex.positionâŠ¸âŠ‘)camera
  ;
    # rotate around camera.position
    # Move target relative to position
    (targetPosition + cameraIndex.positionâŠ‘camera)âŒ¾(cameraIndex.targetâŠ¸âŠ‘)camera
  }
}

# Rotates the camera around its right vector, pitch is "looking up and down"
#  - lockView prevents camera overrotation (aka "somersaults")
#  - rotateAroundTarget defines if rotation is around target or around its position
#  - rotateUp rotates the up direction as well (typically only usefull in CAMERA_FREE)
# NOTE: angle must be provided in radians
CameraPitch â† {angleâ€¿lockViewâ€¿rotateAroundTargetâ€¿rotateUpğ•Šcamera:
  # View vector
  targetPosition â† -Â´cameraIndex.targetâ€¿cameraIndex.positionâŠcamera

  angle {
    up â† GetCameraUp camera
    # In these camera modes we clamp the Pitch angle
    # to allow only viewing straight up or down.

    # Clamp view up
    ğ•© âŒŠâ†© Â¯0.001+up VectorAngle targetPosition

    # Clamp view down
    ğ•© âŒˆ 0.001-(-up) VectorAngle targetPosition
  }âŸlockView â†©

  # Rotation axis
  right â† GetCameraRight camera

  # Rotate view vector around right axis
  targetPosition Vector3RotateByAxisAngleËœâ†©rightâ€¿angle

  camera {rotateAroundTarget?
    # Move position relative to target
    (targetPosition -Ëœ cameraIndex.targetâŠ‘ğ•©)âŒ¾(cameraIndex.positionâŠ¸âŠ‘) ğ•©
  ;
    # rotate around camera.position
    # Move target relative to position
    (targetPosition + cameraIndex.positionâŠ‘ğ•©)âŒ¾(cameraIndex.targetâŠ¸âŠ‘) ğ•©
  } â†©

  # Rotate up direction around right axis
  rightâ€¿angleâŠ¸Vector3RotateByAxisAngleâŒ¾(cameraIndex.upâŠ¸âŠ‘)âŸrotateUp camera
}

# Rotates the camera around its forward vector
# Roll is "turning your head sideways to the left or right"
# Note: angle must be provided in radians
CameraRoll â† {angleğ•Šcamera:
  # Rotation axis
  forward â† GetCameraForward camera

  # Rotate up direction around forward axis
  forwardâ€¿angleâŠ¸Vector3RotateByAxisAngleâŒ¾(cameraIndex.upâŠ¸âŠ‘)camera
}

# Returns the camera view matrix
GetCameraViewMatrix â† {ğ•Šcamera:
  MatrixLookAt cameraIndex.positionâ€¿cameraIndex.targetâ€¿cameraIndex.upâŠcamera
}

# Make GetCameraProjectionMatrix with your own camera cull distance
CustomGetCameraProjectionMatrix â† {ğ•Šcull_distance_nearâ€¿cull_distance_far:
  {aspectğ•Šcamera:
    { ğ•© â‰¡ cameraProjection.camera_perspective?
      MatrixPerspectiveâŸ¨deg2radÃ—cameraIndex.fovyâŠ‘camera, aspect, cull_distance_near, cull_distance_farâŸ©

    ; ğ•© â‰¡ cameraProjection.camera_orthographic?
      top â† 2Ã·ËœcameraIndex.fovyâŠ‘camera
      right â† topÃ—aspect

      MatrixOrthoâŸ¨-right, right, -top, top, cull_distance_near, cull_distance_farâŸ©
    ;
      =âŒœËœâ†•4
    }cameraIndex.projectionâŠ‘camera
  }
}

# Default cull distance
GetCameraProjectionMatrix â† CustomGetCameraProjectionMatrix {ğ”½ğ•˜}0.01â€¿1000

MakeCameraUpdater â† {ğ•ŠâŸ¨
    camera_orbital_speed
    camera_rotation_speed
    camera_move_speed
    camera_pan_speed
    camera_mouse_move_sensitivity
    camera_mouse_scroll_sensitivity
  âŸ©:

  {modeâ€¿mouseDeltağ•Šcamera:
    cm â† cameraMode
    moveInWorldPlane   â† âˆ¨Â´mode=cm.camera_third_person                  â€¿cm.camera_first_person
    rotateAroundTarget â† âˆ¨Â´mode=cm.camera_third_personâ€¿cm.camera_orbital
    lockView           â† âˆ¨Â´mode=cm.camera_third_personâ€¿cm.camera_orbitalâ€¿cm.camera_first_personâ€¿cm.camera_free
    rotateUp           â† 0

    {mode=cm.camera_orbital?
      # Orbital can just orbit
      rotation â† MatrixRotateâŸ¨GetCameraUp camera, camera_orbital_speedÃ—GetFrameTimeâŸ¨âŸ©âŸ©
      view â† -Â´cameraIndex.positionâ€¿cameraIndex.targetâŠcamera
      view MPâ†© rotation
      (cameraIndex.target + view)âŒ¾(cameraIndex.positionâŠ¸âŠ‘)camera
    ;
      frameAdjusting â† 60Ã—GetFrameTimeâŸ¨âŸ©
      # Camera rotation
      camera CameraPitchËœâ†© âŸ¨frameAdjustingÃ—camera_rotation_speedÃ—-Â´IsDownÂ¨upâ€¿down , lockView, rotateAroundTarget, rotateUpâŸ©
      camera CameraYaw  Ëœâ†© âŸ¨frameAdjustingÃ—camera_rotation_speedÃ—-Â´IsDownÂ¨leftâ€¿right, rotateAroundTargetâŸ©
      camera CameraRoll Ëœâ†©  frameAdjustingÃ—camera_rotation_speedÃ—-Â´IsDownÂ¨eâ€¿q

      right   â† moveInWorldPlaneâŠ‘CameraMoveRightâ€¿CameraMoveRightInWorldPlane
      forward â† moveInWorldPlaneâŠ‘CameraMoveForwardâ€¿CameraMoveForwardInWorldPlane

      # Camera movement
      # Camera pan (for CAMERA_FREE)
      {(mode = cm.camera_free) âˆ§ mouse.IsButtonDown mouse.button.middle?
        camera Right       Ëœâ†©  camera_pan_speedÃ—Ã—0âŠ‘mouseDelta
        camera CameraMoveUpËœâ†© -camera_pan_speedÃ—Ã—1âŠ‘mouseDelta
      ;
        # Mouse support
        camera CameraYaw  Ëœâ†©âŸ¨-camera_mouse_move_sensitivityÃ—0âŠ‘mouseDelta, rotateAroundTargetâŸ©
        camera CameraPitchËœâ†©âŸ¨-camera_mouse_move_sensitivityÃ—1âŠ‘mouseDelta, lockView, rotateAroundTarget, rotateUpâŸ©
      }

      # Keyboard support
      camera ForwardËœâ†© frameAdjusting Ã— camera_move_speedÃ—-Â´IsDownÂ¨wâ€¿s
      camera Right  Ëœâ†© frameAdjusting Ã—-camera_move_speedÃ—-Â´IsDownÂ¨aâ€¿d

      # Gamepad movement
      {ğ•¤
        G â† GetGamepadAxisMovement 0âŠ¸â‹ˆ

        # Gamepad controller support
        camera CameraYaw  Ëœâ†©âŸ¨camera_mouse_move_sensitivityÃ—Â¯20Ã—G gamepadAxis.gamepad_axis_right_x,           rotateAroundTargetâŸ©
        camera CameraPitchËœâ†©âŸ¨camera_mouse_move_sensitivityÃ—Â¯20Ã—G gamepadAxis.gamepad_axis_right_y, lockView, rotateAroundTarget, rotateUpâŸ©

        camera ForwardâŸ(Â¯0.25â‰¥G gamepadAxis.gamepad_axis_left_y)Ëœâ†© frameAdjusting Ã—  camera_move_speed
        camera ForwardâŸ( 0.25â‰¤G gamepadAxis.gamepad_axis_left_y)Ëœâ†© frameAdjusting Ã— -camera_move_speed
        camera Right  âŸ(Â¯0.25â‰¥G gamepadAxis.gamepad_axis_left_x)Ëœâ†© frameAdjusting Ã— -camera_move_speed
        camera Right  âŸ( 0.25â‰¤G gamepadAxis.gamepad_axis_left_x)Ëœâ†© frameAdjusting Ã—  camera_move_speed
      }âŸâŠ¢ IsGamepadAvailable 0

      {ğ•¤
        camera CameraMoveUpâŸ(IsDown space       )Ëœâ†© frameAdjusting Ã—  camera_move_speed
        camera CameraMoveUpâŸ(IsDown left_control)Ëœâ†© frameAdjusting Ã— -camera_move_speed
      }âŸâŠ¢mode=cm.camera_free
    }

    {
      # Zoom target distance
      camera CameraMoveToTargetËœâ†©-mouse.WheelMoved@
      camera CameraMoveToTargetËœâ†©2Ã—-Â´IsPressedÂ¨keypad.subtractâ€¿keypad.add
    }âŠ¢âˆ¨Â´mode=cm.camera_third_personâ€¿cm.camera_orbitalâ€¿cm.camera_free
    camera
  }
}

updateCamera â† MakeCameraUpdater {
  camera_orbital_speed  â‡ 0.5
  camera_rotation_speed â‡ 0.03 # Radians per second
  camera_move_speed     â‡ 0.09
  camera_pan_speed      â‡ 0.2

  # Camera mouse movement sensitivity
  camera_mouse_move_sensitivity   â‡ 0.003     # TODO: it should be independant of framerate
  camera_mouse_scroll_sensitivity â‡ 1.5
}


# Update camera movement, movement/rotation values should be provided by user
UpdateCameraPro â† {movementâ€¿rotationâ€¿zoomğ•Šcamera:
  # Required values
  # movement.x - Move forward/backward
  # movement.y - Move right/left
  # movement.z - Move up/down
  # rotation.x - yaw
  # rotation.y - pitch
  # rotation.z - roll
  # zoom - Move towards target

  lockView           â† 1
  rotateAroundTarget â† 0
  rotateUp           â† 0
  moveInWorldPlane   â† 1

  # Camera rotation
  camera CameraYaw  Ëœâ†©âŸ¨-deg2radÃ—0âŠ‘rotation, rotateAroundTargetâŸ©
  camera CameraPitchËœâ†©âŸ¨-deg2radÃ—1âŠ‘rotation, lockView, rotateAroundTarget, rotateUpâŸ©
  camera CameraRoll Ëœâ†©  deg2radÃ—2âŠ‘rotation

  # Camera movement
  camera CameraMoveForwardInWorldPlaneËœâ†© 0âŠ‘movement
  camera CameraMoveRightInWorldPlane  Ëœâ†© 1âŠ‘movement
  camera CameraMoveUp                 Ëœâ†© 2âŠ‘movement

  # Zoom target distance
  CameraMoveToTarget cameraâ€¿zoom
}
