## Metaprogram rayffi.bqn automatically.

ffiUtilsPathâ†âŠ‘â€¢argsâˆ¾<"../ffiUtils.bqn"

raylibJsonTempLoc â† â€¢file.At "inp-out/raylib.json"
outputLocation â† â€¢file.At "../../rayffi.bqn"
binLocation â† â€¢file.At"a.out"

# util functions
nl â† @+10 # newline
Box â† âŸ¨âŸ©âŠ¸â‰¡â—¶âŸ¨>â‹„â†•0â€¿0âŸ©âŠ¢Â»Â¨âŸœ<' 'â¥ŠËœÂ·âŒˆÂ´â‰ Â¨
LowerNames â† +âŸœ(32Ã—1="A["âŠ¸â‹)âŒ¾(1â†‘â‰1âŠ¢)
_MetaParse â† {âˆ¾Ë˜Â´[ğ•—,ğ•¨]{Fâ€¿wğ•Šğ•©:<wâŠ¸âˆ¾Ë˜Box Fğ•©}Ë˜â—‹â‰ğ•©}
SHErr â† {exitcodeâ€¿stdoutâ€¿stderrâ†â€¢SHğ•©
  â€¢Out stdout
  stderr!0=exitcode
}

# imports
âŸ¨raylibPathâŸ© â† â€¢Import "../loadConfig.bqn"
json â† â€¢Import "../imports/bqn-libs/json.bqn"

# getting raylib.h path
raylibHeaderPath â† "include/raylib.h"âˆ¾Ëœ"lib/"âˆ¾Ëœâ¼{ğ•©â†“Ëœ-âŠ‘âŠâŸœ1âŒ½'/'=ğ•©}raylibPath
(â€¢file.Exists raylibHeaderPath)!Ëœ"raylib header file expected at "âˆ¾raylibHeaderPath

# compile c parser if non existant
SHErr âŸ¨"cc"â‹„â€¢file.At"raylib_parser.c"â‹„"-o"â‹„binLocationâŸ©
SHErr binLocationâ€¿"-i"â€¿raylibHeaderPathâ€¿"-f"â€¿"JSON"â€¿"-o"â€¿raylibJsonTempLoc
â€¢file.Remove binLocation

#raygui:
#cc raylib_parser.c && ./a.out -i ./inp-out/raygui.c -f JSON -o ./inp-out/raygui.json && rm ./a.out
#raylib: 
#cc raylib_parser.c && ./a.out -i ./inp-out/raylib.h -f JSON -o ./inp-out/raylib.json && rm ./a.out

remap â† {ğ•ğ•}Â´{(ğ•¨âŠ¸â‰¡âˆ§"*"â‰¡1â†‘âŠ£)â—¶âŸ¨â‹ˆâ‹„ğ•©â‹ˆËœ1â†“âŠ£âŸ©Â´}Â´Â¨âŸ¨
  "unsigned char"  â€¿"ustr"
  "char"           â€¿"str"
  "void"           â€¿"ptr"
  "rAudioBuffer"   â€¿"ptr"
  "rAudioProcessor"â€¿"ptr"
âŸ©
constTextâ†"const "
SwitchOrder â† {âŒ½âŒ¾((ğ•©âˆŠ'0'+â†•10)âŠ¸/)1âŠ¸âŒ½âŒ¾((ğ•©âˆŠ"[]")âŠ¸/)ğ•©}âŒ½

shortendStructNamesâ†[
  "v2"â€¿"Vector2"
  "v3"â€¿"Vector3"
  "v4"â€¿"Vector4"
]

typeReplacements â† â‰shortendStructNamesâˆ¾[
  # remove since they're not defined
  "ptr"â€¿"AudioCallback"
  "ptr"â€¿"LoadFileDataCallback"
  "ptr"â€¿"LoadFileTextCallback"
  "ptr"â€¿"SaveFileDataCallback"
  "ptr"â€¿"SaveFileTextCallback"
  "ptr"â€¿"TraceLogCallback"

  """f64"""â€¿"double"
  """i64"""â€¿"long"
  "f"      â€¿"float"
  "i"      â€¿"int"
  "ptr"    â€¿"..."
  "u"      â€¿"unsigned int"
  "u8"     â€¿"char"
  "u8"     â€¿"unsigned char"
  """u16"""â€¿"unsigned short"
  " "      â€¿"void"
]

mapArgTypes â† {
  [bqn,c] â† typeReplacements
  {
    constsâ†constTextâŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨ğ•©
    s â† Â¬constsâˆ¨Â¬âŠ‘Â¨'*'âŠ¸âˆŠÂ¨ğ•©
    cleanedâ†constTextâŠ¸âˆ¾â¼Â¨âŒ¾(constsâŠ¸/)ğ•©
    [kept,removed] â† 2â€¿âˆ˜â¥Šâ‰RemapâŒ¾âŒ½Ë˜> âˆ¨`âˆ˜âˆŠâŸœ"[*"âŠ¸(Â¬âŠ¸/Â¯1âŠ¸â†“âŸ(" "â‰¡Â¯1âŠ¸â†‘)âŠ¸â‹ˆSwitchOrderâˆ˜/)Â¨cleaned
    AddRemoved â† {""ğ•Šğ•©:ğ•©;'"'â‰¡âŠ‘ğ•©?ğ•¨âŠ¸âˆ¾âŒ¾('"'âŠ¸âˆ¾â¼)ğ•©;'"'âˆ¾ğ•¨âˆ¾"""âˆ¾"âˆ¾ğ•©}
    replaced â† kept LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠkept)âŠbqnâˆ¾0
    removed AddRemovedÂ¨ replaced
  }
}

MapStructTypes â† {
  [bqn,c] â† typeReplacements
  constsâ†constTextâŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨ğ•©
  s â† Â¬constsâˆ¨Â¬âŠ‘Â¨'*'âŠ¸âˆŠÂ¨ğ•©
  cleanedâ†constTextâŠ¸âˆ¾â¼Â¨âŒ¾(constsâŠ¸/)ğ•©
  [kept,removed] â† 2â€¿âˆ˜â¥Šâ‰RemapâŒ¾âŒ½Ë˜> âˆ¨`âˆ˜âˆŠâŸœ"[*"âŠ¸(Â¬âŠ¸/Â¯1âŠ¸â†“âŸ(" "â‰¡Â¯1âŠ¸â†‘)âŠ¸â‹ˆSwitchOrderâˆ˜/)Â¨cleaned
  AddRemoved â† {""ğ•Šğ•©:ğ•©;'"'â‰¡âŠ‘ğ•©?ğ•¨âŠ¸âˆ¾âŒ¾('"'âŠ¸âˆ¾â¼)ğ•©;'"'âˆ¾ğ•¨âˆ¾"""âˆ¾"âˆ¾ğ•©}
  replaced â† kept LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠkept)âŠbqnâˆ¾0
  removed AddRemovedÂ¨ replaced
}

mapStructNames â† {
  [bqn,c]â†â‰shortendStructNames
  {ğ•©LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠğ•©)âŠbqnâˆ¾0}
}

_Time â† {â€¢Show ğ”½â€¢_timedğ•©â‹„ğ”½ğ•©}
mapFuncReturnType â† {
  [bqn,c] â† typeReplacements
  {
    cleanedâ†ğ•©â†“ËœÂ¨constTextâ‰ âŠ¸Ã—constTextâŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨ğ•©
    [kept,removed] â† 2â€¿âˆ˜â¥Šâ‰RemapâŒ¾âŒ½Ë˜> âˆ¨`âˆ˜âˆŠâŸœ"[*"âŠ¸(Â¬âŠ¸/Â¯1âŠ¸â†“âŸ(" "â‰¡Â¯1âŠ¸â†‘)âŠ¸â‹ˆSwitchOrderâˆ˜/)Â¨cleaned
    AddRemoved â† {""ğ•Šğ•©:ğ•©;'"'â‰¡âŠ‘ğ•©?ğ•¨âŠ¸âˆ¾âŒ¾('"'âŠ¸âˆ¾â¼)ğ•©;'"'âˆ¾ğ•¨âˆ¾"""âˆ¾"âˆ¾ğ•©}
    replaced â† kept LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠkept)âŠbqnâˆ¾0
    {'('âˆ¾ğ•©âˆ¾')'}âŸ(âˆ¨Â´"âˆ¾âŠ£"âŠ¸âˆŠ)Â¨"ptrâŠ£"âŠ¸âˆ¾âŸ(("ustr"â‰¡Â¯4âŠ¸â†‘)âˆ¨âˆ¨Â´âˆ˜=âŸœ'*'âˆ¨"str"â‰¡Â¯3âŠ¸â†‘)Â¨ removed AddRemovedÂ¨ replaced
  }
}

definesâ€¿structsâ€¿aliasesâ€¿enumsâ€¿callbacksâ€¿functionsâ†{
  xâ†json.Parse â€¢FChars raylibJsonTempLoc
  !xâŠ£ËâŠ¸â‰¡"defines"â€¿"structs"â€¿"aliases"â€¿"enums"â€¿"callbacks"â€¿"functions"
  âŠ¢ËÂ¨Â¨âŒ¾(0â€¿1â€¿3â€¿4â€¿5âŠ¸âŠ)âŠ¢Ëx
}

outputLocation â€¢FLines âˆ¨`âŒ¾âŒ½âˆ˜â‰ âŸœ' 'âŠ¸/Â¨âˆ¾âŸ¨
  â€¢FLines "topOfRayffi.bqn"
  â‹ˆ""
  â‹ˆ"âŸ¨raylibPathâŸ© â† â€¢Import ""src/loadConfig.bqn"""
  â‹ˆ"r â‡ MakeImporter raylibPath"
  â‹ˆ""
  { # defines
    exclTypes  â† "GUARD"â€¿"MACRO"â€¿"UNKNOWN"â€¿"FLOAT_MATH"â€¿"COLOR"
    Filter â† {ğ•Šnameâ€¿typeâ€¿valâ€¿desc:
      Â¬âˆ¨Â´âŸ¨"PI"â‰¡name, âˆ¨Â´typeâŠ¸â‰¡Â¨exclTypes, âŸ¨âŸ©â‰¡val âŸ©
    }
    filtered â† FilterË˜âŠ¸/>defines
    <Ë˜""â€¿""â€¿" â‡ "â€¿" # "âŸ¨LowerNamesÂ¨,âŸ¨âŸ©Â¨,â€¢ReprÂ¨,âŠ¢âŸ©_MetaParse filtered
  }
  â‹ˆ""
  { # enums
    [names,descriptions,values]â†â‰>enums
    tabled â† >Â¨âŠ¢ËÂ¨Â¨ values
    prefixesRemoved â† {ğ•©â†“Â¨Ëœ+Â´âˆ§ËË˜âˆ§`(âŠ=â‰)>ğ•©â†‘Â¨ËœâŒŠÂ´â‰ Â¨ğ•©}âŒ¾(âŠË˜)Â¨tabled
    bodys â† (<Ë˜("  ")â€¿" â‡ "â€¿"  # "âŸ¨LowerNamesÂ¨,â€¢ReprÂ¨,âŠ¢âŸ©_MetaParseâŠ¢)Â¨prefixesRemoved
    headers â† names LowerNamesâŠ¸âˆ¾Â¨<Ë˜" â‡ { # "âŠ¸âˆ¾Ë˜Box descriptions
    âˆ¾headers<âŠ¸âˆ¾Â¨âˆ¾âŸœâŸ¨"}"âŸ©Â¨bodys
  }
  â‹ˆ""
  { # structs
    [names,descriptions,fields]â†â‰>structs
    headers â† (MapStructNames names) âˆ¾âŸœ" â‡ âŸ¨ # "âŠ¸âˆ¾Â¨ descriptions
    bodys â† {âŸ¨"âŸ©"âŸ©âˆ¾Ëœ<Ë˜"  "â€¿" # "â€¿"  # "âŸ¨MapStructTypes,âŠ¢,âŠ¢âŸ©_MetaParse >ğ•©}Â¨âŠ¢ËÂ¨Â¨fields
    assembled â† headers <âŠ¸âˆ¾Â¨ bodys
    aliasLinesâ†Â»âŠ¸âˆ¨âˆ˜â‰ âŸœ' 'âŠ¸/Â¨<Ë˜""â€¿" â‡ "â€¿" # "âŸ¨LowerNamesÂ¨,MapArgTypes,âŠ¢âŸ©_MetaParse âŒ½âŒ¾(2âŠ¸â†‘)Ë˜>âŠ¢ËÂ¨aliases
    pâ†âŠ‘Â¨âŠ¢ËÂ¨aliases
    âˆ¾ âˆ¾âˆ¾âŸœ(â‹ˆâ‹ˆ)Â¨âŸœaliasLinesâŒ¾(Â¯1âŠ¸â†“)assembledâŠ”Ëœ+`Â»+Ëpâ‰¡âŒœnames
  }
  â‹ˆ""
  { # functions
    #â€¢ShowÂ¨âŒ¾(330â€¿307âŠ¸âŠ)
    s â† {
      ((âŠ‘'*'âŠ¸âˆŠ)Â¨âˆ§constTextâŠ¸(âŠ£â‰¢â‰ âŠ¸â†‘)Â¨)1â€¿0âŠ¸âŠ‘Â¨Â¯1âŠ‘ğ•©
    }Â¨âˆ¾âŸœâŸ¨âŸ¨âŸ©âŸ©âŸ(3=â‰ )Â¨functions
    sLinesâ†âˆ¨Â´Â¨s

    s2 â† {
      "const void *"âŠ¸â‰¡Â¨1â€¿0âŠ¸âŠ‘Â¨Â¯1âŠ‘ğ•©
    }Â¨âˆ¾âŸœâŸ¨âŸ¨âŸ©âŸ©âŸ(3=â‰ )Â¨functions
    s2Linesâ†âˆ¨Â´Â¨s2
    !âˆ§Â´Â¬s2Linesâˆ§sLines # I don't want the lines to collide
    
    sAllLinesExtended â† (â†•âˆ˜â‰ âŠ¸+âŒ¾/â†‘Ëœ+Â´+â‰ )s2Linesâˆ¨sLines
    s1LinesExtendedâ€¿s2LinesExtended â† s2Lines{((+Â´+â‰ )ğ•©+ğ•¨)â†‘ğ•¨âŠ¸{((/ğ•¨)Â¬âˆ˜âˆŠËœğ•©)/ğ•©+â†•â‰ ğ•©}âŒ¾/ğ•¨+ğ•©}{ğ”½â‹ˆğ”½Ëœ}sLines
    MakeConstDistinct â† (sAllLinesExtendedÂ¬âŠ¸Ã—(1+s2Linesâˆ¨sLines)/s+2Ã—s2){'âŸ©'âˆ¾Ëœ1â†“âˆ¾'â‹„'âˆ¾Â¨(âŠ‘"ptr"â€¿"ustr"â€¿"str"âŠ<)â—¶âŸ¨"""&u8"""â‹„"""&u8"""â‹„"""&u8:c8"""â‹„"""&"âŠ¸âˆ¾"""*"âŠ¸âˆ¾â¼âŸ©Â¨âŒ¾((1=ğ•¨)âŠ¸/)"""*i8"""Â¨âŒ¾((2=ğ•¨)âŠ¸/)ğ•©}Â¨âŠ¢

    <Ë˜""â€¿" â‡ "â€¿""""â€¿" _RâŸ¨"â€¿"#"â€¿" # "âŸ¨
      âˆ¾âŸœ"Raw"Â¨âŒ¾((Â»s2LinesExtended)âŠ¸/)Â·âˆ¾âŸœ"Ref"Â¨âŒ¾((Â»s1LinesExtended)âŠ¸/)LowerNamesÂ¨ â‹„ MapFuncReturnType â‹„ âˆ¾âŸœ'"'Â¨ â‹„ MakeConstDistinct MapArgTypesÂ¨ â‹„ (âˆ¾' 'âŠ¸âˆ¾Â¨)Â¨ â‹„ âŠ¢
    âŸ©_MetaParse{
      0â€¿2â€¿0â€¿3â€¿4â€¿1âŠ(3â†‘ğ•©)âˆ¾â‰{<Ë˜â‰âˆ˜â€¿2â¥ŠâŠ¢ËË˜>âŠ‘ğ•©}Ë˜âŠ¢Ëğ•©
    }âŒ¾â‰(1+s2Linesâˆ¨sLines)/>âˆ¾âŸœâŸ¨âŸ¨âŸ©âŸ©âŸ(3=â‰ )Â¨functions
  }
âŸ©
â€¢file.Remove raylibJsonTempLoc
