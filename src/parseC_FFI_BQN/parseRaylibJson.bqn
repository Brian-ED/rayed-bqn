## Metaprogram rayffi.bqn automatically.

ffiUtilsPathâ†âŠ‘â€¢argsâˆ¾<"../ffiUtils.bqn"

raylibJsonTempLoc â† "inp-out/raylib.json"
outputLocation â† "./inp-out/rayffi.bqn"

# util functions
nl â† @+10 # newline
Box â† âŸ¨âŸ©âŠ¸â‰¡â—¶âŸ¨>â‹„â†•0â€¿0âŸ©âŠ¢Â»Â¨âŸœ<' 'â¥ŠËœÂ·âŒˆÂ´â‰ Â¨
LowerNames â† +âŸœ(32Ã—1="A["âŠ¸â‹)âŒ¾(1â†‘â‰1âŠ¢)
_MetaParse â† {âˆ¾Ë˜Â´[ğ•—,ğ•¨]{Fâ€¿wğ•Šğ•©:<wâŠ¸âˆ¾Ë˜Box Fğ•©}Ë˜â—‹â‰ğ•©}
SHErr â† {exitcodeâ€¿stdoutâ€¿stderrâ†â€¢SHğ•©
  â€¢Out stdout
  stderr!0=exitcode
}

# imports
âŸ¨raylibPathâŸ© â† â€¢Import"../loadConfig.bqn"
json â† â€¢Import "../imports/bqn-libs/json.bqn"

# getting raylib.h path
raylibHeaderPath â† "include/raylib.h"âˆ¾Ëœ"lib/"âˆ¾Ëœâ¼{ğ•©â†“Ëœ-âŠ‘âŠâŸœ1âŒ½'/'=ğ•©}raylibPath
(â€¢file.Exists raylibHeaderPath)!Ëœ"raylib header file expected at "âˆ¾raylibHeaderPath

# compile c parser if non existant

SHErr "cc"â€¿"raylib_parser.c"
SHErr "./a.out"â€¿"-i"â€¿raylibHeaderPathâ€¿"-f"â€¿"JSON"â€¿"-o"â€¿raylibJsonTempLoc
â€¢file.Remove"a.out"

#raygui:
#cc raylib_parser.c && ./a.out -i ./inp-out/raygui.c -f JSON -o ./inp-out/raygui.json && rm ./a.out
#raylib: 
#cc raylib_parser.c && ./a.out -i ./inp-out/raylib.h -f JSON -o ./inp-out/raylib.json && rm ./a.out

mapArgTypes â† {ğ•Š[bqn,c]:
  remap â† {ğ•ğ•}Â´{(ğ•¨âŠ¸â‰¡âˆ§"*"â‰¡1â†‘âŠ£)â—¶âŸ¨â‹ˆâ‹„ğ•©â‹ˆËœ1â†“âŠ£âŸ©Â´}Â´Â¨âŸ¨
    "unsigned char"  â€¿"ustr"
    "char"           â€¿"str"
    "void"           â€¿"ptr"
    "rAudioBuffer"   â€¿"ptr"
    "rAudioProcessor"â€¿"ptr"
  âŸ©
  {
    constTextâ†"const "
    constsâ†constTextâŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨ğ•©
    cleanedâ†constTextâŠ¸âˆ¾â¼Â¨âŒ¾(constsâŠ¸/)ğ•©
    SwitchOrder â† {âŒ½âŒ¾((ğ•©âˆŠ'0'+â†•10)âŠ¸/)1âŠ¸âŒ½âŒ¾((ğ•©âˆŠ"[]")âŠ¸/)ğ•©}âŒ½
    [kept,removed] â† 2â€¿âˆ˜â¥Šâ‰RemapâŒ¾âŒ½Ë˜> âˆ¨`âˆ˜âˆŠâŸœ"[*"âŠ¸(Â¬âŠ¸/Â¯1âŠ¸â†“âŸ(" "â‰¡Â¯1âŠ¸â†‘)âŠ¸â‹ˆSwitchOrderâˆ˜/)Â¨cleaned
    AddRemoved â† {""ğ•Šğ•©:ğ•©;'"'â‰¡âŠ‘ğ•©?ğ•¨âŠ¸âˆ¾âŒ¾('"'âŠ¸âˆ¾â¼)ğ•©;'"'âˆ¾ğ•¨âˆ¾"""âˆ¾"âˆ¾ğ•©}
    removed AddRemovedÂ¨ kept LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠkept)âŠbqnâˆ¾<0
  }
} â‰[
  # remove since they're not defined
  "ptr"â€¿"AudioCallback"
  "ptr"â€¿"LoadFileDataCallback"
  "ptr"â€¿"LoadFileTextCallback"
  "ptr"â€¿"SaveFileDataCallback"
  "ptr"â€¿"SaveFileTextCallback"
  "ptr"â€¿"TraceLogCallback"

  # shorten struct names
  "camera3D"     â€¿"Camera"
  "renderTexture"â€¿"RenderTexture2D"
  "texture"      â€¿"Texture2D"
  "texture"      â€¿"TextureCubemap"
  "v2"           â€¿"Vector2"
  "v3"           â€¿"Vector3"
  "v4"           â€¿"Vector4"

  """f64""" â€¿"double"
  """i64""" â€¿"long"
  "f"       â€¿"float"
  "i"       â€¿"int"
  "ptr"     â€¿"..."
  "u"       â€¿"unsigned int"
  "u8"      â€¿"char"
  "u8"      â€¿"unsigned char"
  """u16""" â€¿"unsigned short"
]

MapStructTypes â† "ptrâŠ£"âŠ¸âˆ¾âŸ(("ustr"â‰¡4âŠ¸â†‘)âˆ¨âˆ¨Â´âˆ˜=âŸœ'*'âˆ¨"str"â‰¡3âŠ¸â†‘)Â¨ MapArgTypes

mapStructNames â† {ğ•Š[bqn,c]:{ğ•©LowerNamesâˆ˜âŠ£âŸ(0âŠ¸â‰¡)Â¨(câŠğ•©)âŠbqnâˆ¾<0}6â†“âŸ("const "â‰¡â†‘)Â¨âŠ¢}â‰[  
  "v4"â€¿"Vector4"
  "v3"â€¿"Vector3"
  "v2"â€¿"Vector2"
]

_Time â† {â€¢Show ğ”½â€¢_timedğ•©â‹„ğ”½ğ•©}
MapFuncReturnType â† " "âŸ("void"âŠ¸â‰¡)Â¨Â·{'('âˆ¾ğ•©âˆ¾')'}âŸ(âˆ¨Â´"âˆ¾âŠ£"âŠ¸âˆŠ)Â¨MapStructTypes

definesâ€¿structsâ€¿aliasesâ€¿enumsâ€¿callbacksâ€¿functionsâ†{
  xâ†â‰json.Parse â€¢FChars raylibJsonTempLoc
  !(âŠË˜x)â‰¡"defines"â€¿"structs"â€¿"aliases"â€¿"enums"â€¿"callbacks"â€¿"functions"
  âŠ¢ËÂ¨Â¨1âŠË˜x
}

outputLocation â€¢FLines âˆ¨`âŒ¾âŒ½âˆ˜â‰ âŸœ' 'âŠ¸/Â¨âˆ¾âŸ¨
  â€¢FLines "topOfRayffi.bqn"
  â‹ˆ""
  â‹ˆ"r â‡ MakeImporter """âˆ¾raylibPathâˆ¾'"'
  â‹ˆ""
  { # defines
    Parse â† ""â€¿""â€¿" â‡ "â€¿" # "âŸ¨LowerNamesÂ¨,âŸ¨âŸ©Â¨,â€¢ReprÂ¨,âŠ¢âŸ©_MetaParseâŠ¢
    exclTypes  â† "GUARD"â€¿"MACRO"â€¿"UNKNOWN"â€¿"FLOAT_MATH"â€¿"COLOR"
    Filter     â† {ğ•Šnâ€¿tâ€¿vâ€¿d: # nameâ€¿typeâ€¿valâ€¿desc
      Â¬âˆ¨Â´âŸ¨"PI"â‰¡n, âˆ¨Â´tâŠ¸â‰¡Â¨exclTypes, âŸ¨âŸ©â‰¡v âŸ©
    }
    <Ë˜Parse FilterË˜âŠ¸/>defines
  }
  â‹ˆ""
  { # enums
    [names,descriptions,values]â†â‰>enums
    tabled â† >Â¨âŠ¢ËÂ¨Â¨ values
    prefixesRemoved â† {ğ•©â†“Â¨Ëœ+Â´âˆ§ËË˜âˆ§`(âŠ=â‰)>ğ•©â†‘Â¨ËœâŒŠÂ´â‰ Â¨ğ•©}âŒ¾(âŠË˜)Â¨tabled
    bodys â† (â¥Š(nlâˆ¾"  ")â€¿" â‡ "â€¿"  # "âŸ¨LowerNamesÂ¨,â€¢ReprÂ¨,âŠ¢âŸ©_MetaParseâŠ¢)Â¨prefixesRemoved
    headers â† names LowerNamesâŠ¸âˆ¾Â¨<Ë˜" â‡ { # "âŠ¸âˆ¾Ë˜Box descriptions
    âˆ¾nlâŠ¸((âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢)Â¨ headersâˆ¾Â¨âˆ¾âŸœnlâ€¿'}'Â¨bodys
  }
  â‹ˆ""
  { # structs
    ParseStruct â† {
      âˆ¾nlâˆ¾Â¨"âŸ©"âˆ¾Ëœ<Ë˜"  "â€¿" # "â€¿"  # "âŸ¨MapStructTypes,âŠ¢,âŠ¢âŸ©_MetaParse >ğ•©
    }
    [names,descriptions,fields]â†â‰>structs
    headers â† Â»âŠ¸âˆ¨âˆ˜â‰ âŸœ' 'âŠ¸/Â¨<Ë˜""â€¿" â‡ âŸ¨ # "âŸ¨LowerNamesÂ¨,âŠ¢âŸ©_MetaParse descriptions â‰Ë˜Ëœ MapStructNames names
    â€¢Show 
    â€¢Show aliasAfterStructsâ†âŠ‘Â¨âŠ¢ËÂ¨aliases
    â€¢Show â‰¡Â¨âŠ¢ËÂ¨aliases
    #â€¢Show 1â†“â¥Šnlâˆ¾Ë˜""â€¿" â‡ "â€¿" # "âŸ¨LowerNamesÂ¨,LowerNamesÂ¨MapArgTypes,âŠ¢âŸ©_MetaParse âŒ½âŒ¾(2âŠ¸â†‘)Ë˜>aliases
    bodys â† âˆ¨`âŒ¾âŒ½âˆ˜â‰ âŸœ' 'âŠ¸/Â¨<Ë˜âŸ¨""âŸ©âŸ¨ParseStructÂ¨âŸ©_MetaParse â‰Ë˜âŠ¢ËÂ¨Â¨fields
    âˆ¾nlâŠ¸((âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢)Â¨bodysâˆ¾ËœÂ¨headers
  }
  â‹ˆ""
  { # functions
    <Ë˜""â€¿" â‡ "â€¿""""â€¿" _RâŸ¨"â€¿"#"â€¿" # "âŸ¨
      LowerNamesÂ¨ â‹„ MapFuncReturnType â‹„ âˆ¾âŸœ'"'Â¨ â‹„ ('âŸ©'âˆ¾Ëœ1â†“Â·âˆ¾'â‹„'âˆ¾Â¨MapArgTypes)Â¨ â‹„ (âˆ¾' 'âŠ¸âˆ¾Â¨)Â¨ â‹„ âŠ¢
    âŸ©_MetaParse{
      0â€¿2â€¿0â€¿3â€¿4â€¿1âŠ(3â†‘ğ•©)âˆ¾â‰{<Ë˜â‰âˆ˜â€¿2â¥ŠâŠ¢ËË˜>âŠ‘ğ•©}Ë˜âŠ¢Ëğ•©
    }âŒ¾â‰>âˆ¾âŸœ(<âŸ¨âŸ©)âŸ(3=â‰ )Â¨functions
  }
âŸ©
#â€¢file.Remove raylibJsonTempLoc
