âŸ¨color, window, draw, rayffi, keyâŸ©â†râ†â€¢Import "../../raylib.bqn"
âŸ¨materialStructâ‡materialâŸ© â† rayffi
Show â† {â€¢Out ('â€'-@)âŠ¸+âŒ¾((@=f)âŠ¸/)fâ†â€¢Fmtğ•© â‹„ â€¢term.Flush@ â‹„ ğ•©}

# Light type
###typedef enum {
lightType â† {
    directional â‡ 0
    point       â‡ 1
}

modelType â† {
  transform     â‡ 0 # Matrix transform    # Local transform matrix
  meshCount     â‡ 1 # meshCount           # Number of meshes
  materialCount â‡ 2 # materialCount       # Number of materials
  meshes        â‡ 3 # Mesh *meshes        # Meshes array
  materials     â‡ 4 # Material *materials # Materials array
  meshMaterial  â‡ 5 # int *meshMaterial   # Mesh material number
  boneCount     â‡ 6 # int boneCount       # Number of bones
  bones         â‡ 7 # BoneInfo *bones     # Bones information (skeleton)
  bindPose      â‡ 8 # Transform *bindPose # Bones base transformation (pose)
}

shaderType â† {
    programID â‡ 0 # u         # Shader program id
    locs    â‡ 1 # ptr (P i) # Shader locations array (RL_MAX_SHADER_LOCATIONS)
}

# Send light properties to shader
# NOTE: Light shader locations should be available 
#RLights END

rayffi.SetConfigFlags r.window.configFlags.msaa_4x_hint  # Enable Multi Sampling Anti Aliasing 4x (if available)

_withConsts â† {ğ”½_ğ•£ ğ•©:
    # Define the camera to look into our 3d world
    camera â†âŸ¨
        3â€¿3â€¿3   # position   # Camera position
        0â€¿1â€¿0Ã·2 # target     # Camera looking at point
        0â€¿1â€¿0   # up         # Camera up vector (rotation towards target)
        45      # fovy       # Camera field-of-view Y
        0       # projection # Camera projection type
    âŸ©
    # Load plane model from a generated mesh
    modelâ€¿cube â† rayffi.LoadModelFromMeshÂ¨âŸ¨rayffi.GenMeshPlane 10â€¿10â€¿3â€¿3 
                                           rayffi.GenMeshCube  2â€¿4â€¿2âŸ©

    # Load basic lighting shader
    # loadShader â† "../../C/raylib/src/libraylib.so" â€¢FFI "*:i8"â€¿"LoadShader"â€¿"*i8:c8"â€¿"*i8:c8"
    shader â† rayffi.LoadShader â€¢file.AtÂ¨"lighting."âŠ¸âˆ¾Â¨"vs"â€¿"fs"
    font â† r.font.LoadBQN 100
    # Get some required shader locations
    { # shader.locs[SHADER_LOC_VECTOR_VIEW] = GetShaderLocation(shader, "viewPos");
        ptr â† shaderType.locs âŠ‘ shader
        movedPtr â† ptr r.rayffi.MovePtrËœ8Ã—r.shaderLocationIndex.vector_view
        
        movedPtr rayffi.ReadËœâ‹ˆrayffi.GetShaderLocation shaderâ‹ˆ"viewPos"âˆ¾@
        
        # shader.locs[SHADER_LOC_VECTOR_VIEW] = GetShaderLocation(shader, "viewPos");
    }
    # Ambient light level (some basic lighting)
    ambientLoc â† rayffi.GetShaderLocation shaderâ‹ˆ"ambient"âˆ¾@
    rayffi.SetShaderValue âŸ¨shader, ambientLoc, Ã·10â€¿10â€¿10â€¿1, r.shaderUniformDataType.vec4âŸ©
    
    # Assign out lighting shader to model
    {shader rayffi.Read modelType.materials âŠ‘ ğ•©}Â¨modelâ€¿cube
    # model.materials[0].shader â† shader;
    # cube .materials[0].shader â† shader;

    # Create lights
    CreateLight â† {ğ•ŠâŸ¨
            position    # Vector3
            target      # Vector3
            color       # Color
            pKey
            lightsCount
        âŸ©:
        typeâ€¿positionâ€¿targetâ€¿colorâ‡
        colorÃ·â†©255
        enabled â‡ 1
        type â† lightType.point

        # NOTE: Lighting shader naming must be the provided ones
        F â† {typeâ€¿var:
            loc â† rayffi.GetShaderLocation shaderâ‹ˆ"lights["âˆ¾(â€¢Repr lightsCount)âˆ¾"]."âˆ¾varâˆ¾@
            {ğ•©âŠ£rayffi.SetShaderValue âŸ¨shaderâ‹„locâ‹„â¥Šğ•©â‹„typeâŸ©}
        }
        su â† r.shaderUniformDataType
        setEnabled  â† {ğ•Šn: Gâ†{enabled  â†© Nğ•©} â‹„ G enabled  â‹„ g} F su.int â€¿"enabled"
        setType     â‡ {ğ•Šn: Gâ†{type     â†© Nğ•©} â‹„ G type     â‹„ g} F su.int â€¿"type"
        setPosition â‡ {ğ•Šn: Gâ†{position â†© Nğ•©} â‹„ G position â‹„ g} F su.vec3â€¿"position"
        setTarget   â‡ {ğ•Šn: Gâ†{target   â†© Nğ•©} â‹„ G target   â‹„ g} F su.vec3â€¿"target"
        setColor    â‡ {ğ•Šn: Gâ†{color    â†© Nğ•©} â‹„ G color    â‹„ g} F su.vec4â€¿"color"
        Toggle      â‡ {ğ•Š: SetEnabledÂ¬enabled}âŸ(key.IsPressedâˆ˜pKey)
        
    }
    lights â† CreateLightÂ¨({aâ€¿bâ€¿k:âŸ¨aâ‹„3â¥Š0â‹„bâ‹„kâŸ©}Â¨âˆ¾Â¨â†•âˆ˜â‰ )âŸ¨
        âŸ¨Â¯2â€¿1â€¿Â¯2 â‹„ color.yellow â‹„ key.yâŸ©
        âŸ¨ 2â€¿1â€¿ 2 â‹„ color.red    â‹„ key.râŸ©
        âŸ¨Â¯2â€¿1â€¿ 2 â‹„ color.green  â‹„ key.gâŸ©
        âŸ¨ 2â€¿1â€¿Â¯2 â‹„ color.blue   â‹„ key.bâŸ©
    âŸ©
    font ğ”½ cameraâ€¿shaderâ€¿lightsâ€¿cubeâ€¿model
    r.font.Unload font
    rayffi.UnloadModelÂ¨ modelâ€¿cube
    rayffi.UnloadShader shader
}

# Draw a model (with texture if set)
DrawModel â† {ğ•Šmodelâ€¿positionâ€¿scaleâ€¿tint:
    rotationAxis â† 0â€¿1â€¿0
    rayffi.DrawModelExâŸ¨model, position, rotationAxis, 0, 3â¥Šscale, tintâŸ©
}

# Main game loop
PerFrame â† {fontğ•Šcameraâ€¿shaderâ€¿lightsâ€¿cubeâ€¿model:
    rayffi.UpdateCamera âŸ¨cameraâŸ©â€¿r.cameramode.orbital # TODO may not work, &camera â†’ âŸ¨cameraâŸ©
    rayffi.SetShaderValue âŸ¨
        shader
        {
            locsPtr â† shaderType.locsâŠ‘shader # shader.locs
            âŠ‘1 rayffi.MakeI32 (r.shaderLocationIndex.vector_viewÃ—4) rayffi.MovePtr locsPtr  # locsPtr[SHADER_LOC_VECTOR_VIEW]
        }
        âŠ‘camera
        r.shaderUniformDataType.vec3
    âŸ©
    lights {ğ•¨.Toggle@}âŸ(key.IsPressedâŠ¢)Â¨âŸ¨key.yâ‹„key.râ‹„key.gâ‹„key.bâŸ©
    {ğ•¤
        DrawModelÂ¨<âŠ¸âˆ¾âŸœâŸ¨3â¥Š0 â‹„ 1 â‹„ color.whiteâŸ©Â¨cubeâ€¿model
        # Draw spheres to show where the lights are
        {ğ•©.enabled? rayffi.DrawSphereEx ğ•©.positionâ€¿0.2â€¿8â€¿8â€¿(ğ•©.colorÃ—255)
        ;           rayffi.DrawSphereWires 76âŒ¾âŠ‘âŒ¾âŒ½âŒ¾âŠ‘âŒ¾âŒ½ âŸ¨ğ•©.position, 0.2, 8, 8, ğ•©.colorÃ—255âŸ©
        }Â¨lights
        rayffi.DrawGrid 10â€¿1
    } draw._in3D camera

    rayffi.DrawFPS 10â€¿10
    color.darkgrayâ€¿fontâ€¿30 draw.Text 10â€¿40â‹ˆ"Use keys [Y][R][G][B] to toggle lights"

    (key.rightâ€¿key.upâ€¿key.e -â—‹key.IsPressed key.leftâ€¿key.downâ€¿key.q)âŠ¸+âŒ¾(âŠ‘âŠ‘)ğ•©
}draw._withCanvas_ color.raywhite

Game â† PerFrameâ€¢_While_(Â¬window.ShouldClose) _withConsts
Game window._openAs "raylib [shaders] example - basic lighting"

