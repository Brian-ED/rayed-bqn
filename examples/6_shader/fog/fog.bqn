âŸ¨color,window,draw,rfâ‡rayffiâŸ©â†râ†â€¢Import "../../../raylib.bqn"
# Idea: "Construct": makes structs from pointer 

âŸ¨MPâŸ©â†â€¢Import "../../../src/imports/bqn-libs/matrix.bqn"

# Model, meshes, materials and animation data
modelIndex â† {
  transform        â‡ 0           
  num_of_meshes    â‡ 1              
  num_of_materials â‡ 2                 
  meshes           â‡ 3 # Meshes array
  materials        â‡ 4 # Materials array
  meshMaterial     â‡ 5 # Mesh material number
  boneCount        â‡ 6 # Number of bones
  bones            â‡ 7 # Bones information (skeleton)
  bindPose         â‡ 8 # Bones base transformation (pose)
}

# Send light properties to shader
# NOTE: Light shader locations should be available 
UpdateLightValues â† {
    ğ•©.SetEnabled ğ•©.enabled
    ğ•©.SetType    ğ•©.type
    ğ•©.SetPos     ğ•©.pos
    ğ•©.SetTarget  ğ•©.target
    ğ•©.SetColor   ğ•©.colorÃ·255
    ğ•©
}

Printâ†{ğ•¤
    â€¢ShowÂ¨{1â‰¡â€¢Type ğ•©?âŒŠâŒ¾(1e3âŠ¸Ã—)ğ•©;ğ•©}âš‡0 ğ•©
    â€¢term.Flush@
    ğ•©
}

MakeShaderVarSetter â† {shaderğ•ŠshaderVarâ€¿shaderType:
    i â† rf.GetShaderLocation shaderâ‹ˆğ•©âˆ¾@
    intâ€¿vec3â€¿vec4â‡r.shaderUniformDataType
    {
        shaderType{
            ğ•¨=int ? !âŒŠâŠ¸â‰¡ğ•©;
            ğ•¨=vec3? !(âˆ§Â´1=â€¢TypeÂ¨ğ•©)âˆ§âŸ¨3âŸ©â‰¡â‰¢ğ•©;
            ğ•¨=vec4? !(âˆ§Â´1=â€¢TypeÂ¨ğ•©)âˆ§âŸ¨4âŸ©â‰¡â‰¢ğ•©;
            !"Type not defined"
        }ğ•©
        rf.SetShaderValue shaderâ€¿iâ€¿(â‹ˆğ•©)â€¿shaderType
    }
}

# Create a light and get shader locations
CreateLight â† {lightsCountğ•ŠâŸ¨xâ€¿yâ€¿zâ‹„colorâ‹„shaderâŸ©:
  shader UpdateLightValues {
    type           â‡ r.textureFilter.point
    enabledâ€¿Toggle â‡ 1â€¿{ğ•Š: enabledÂ¬â†©}
    pos            â‡ xâ€¿yâ€¿z
    target         â‡ 0â€¿0â€¿0
    color          â‡ color
  # NOTE: Lighting shader naming must be the provided ones
    âŸ¨SetEnabled, SetType, SetPos, SetTarget, SetColorâŸ© â‡ shaderâŠ¸MakeShaderVarSetterÂ¨âŸ¨
        "enabled" â€¿r.shaderUniformDataType.int
        "type"    â€¿r.shaderUniformDataType.int
        "position"â€¿r.shaderUniformDataType.vec3
        "target"  â€¿r.shaderUniformDataType.vec3
        "color"   â€¿r.shaderUniformDataType.vec4
    âŸ©
  }
}

{ğ•¤
    rf.SetConfigFlags window.configFlags.msaa_4x_hint  # Enable Multi Sampling Anti Aliasing 4x (if available)

    camera â† âŸ¨
        2â€¿2â€¿6                        # Camera position
        0â€¿1â€¿0Ã·2                      # Camera looking at point
        0â€¿1â€¿0                        # Camera up vector (rotation towards target)
        45                           # Camera field-of-view Y
        r.cameraProjection.perspective # Camera projection type
    âŸ©
    # Load models and texture
    âŸ¨donutModelâ‹„cubeModelâ‹„sphereModel
    âŸ© â† rf.LoadModelFromMeshÂ¨âŸ¨
        rf.GenMeshTorus  0.4â€¿1â€¿16â€¿32
        rf.GenMeshCube   3â¥Š1
        rf.GenMeshSphere 0.5â€¿32â€¿32
    âŸ©
    texture â† rf.LoadTexture "texel_checker.png"âˆ¾@

    # Assign texture to default model material
    F â† {
        materialsPtr â† â€¢Show modelIndex.materialsâŠ‘ğ•©
        memoryIndexOfMaps â† 8+4
        ptrToMaps â† memoryIndexOfMaps rf.MovePtr materialsPtr
        texture rf.Read r.materialMapIndex.albedo rf.MovePtr ptrToMaps
    }
    FÂ¨donutModelâ€¿cubeModelâ€¿sphereModel

    # Load shader and set up some uniforms
    shader â† rf.LoadShader â€¢file.AtÂ¨"lighting.vs"â€¿"fog.fs"
    shaderLocsIndex â† 1

    locsPtr â† shaderLocsIndexâŠ‘shader
    {
        dataUpTo â† locsPtr rf.MakeI32Ëœr.shaderLocationIndex.matrix_model
        (dataUpToâˆ¾rf.GetShaderLocation shaderâ‹ˆ"matModel"âˆ¾@) rf.ReadI32 locsPtr
    }
    {
        dataUpTo â† locsPtr rf.MakeI32Ëœr.shaderLocationIndex.vector_view
        (dataUpToâˆ¾rf.GetShaderLocation shaderâ‹ˆ"viewPos"âˆ¾@) rf.ReadI32 locsPtr
    }
    # Ambient light level
    ambientLoc â† rf.GetShaderLocation shaderâ‹ˆ"ambient"âˆ¾@
    rf.SetShaderValueâŸ¨shader, ambientLoc, Ã·1âˆ¾Ëœ3â¥Š5, r.shaderUniformDataType.vec4âŸ©

    fogDensity â† 0.15
    fogDensityLoc â† rf.GetShaderLocation shaderâ‹ˆ"fogDensity"âˆ¾@
    rf.SetShaderValueâŸ¨shader, fogDensityLoc, âŸ¨fogDensityâŸ©, r.shaderUniformDataType.floatâŸ©
    
    # NOTE: All models share the same shader
    {
        matsPtr â† modelIndex.materials âŠ‘ ğ•©
        
        (âˆ¾rf.U32ToI8âŒ¾âŠ‘shader) rf.Read matsPtr
    }Â¨âŸ¨donutModel â‹„ cubeModel â‹„ sphereModelâŸ©
    
    # Using just 1 point lights
    0 CreateLightâŸ¨0â€¿2â€¿6, r.color.white, shaderâŸ©

    # Main game loop
    {ğ•¤
        # Update
        rf.UpdateCamera âŸ¨cameraâŸ©â‹ˆr.cameramode.orbital
        
        {ğ•¤
            fogDensity +â†© 0.001
            {fogDensityâ†©ğ•©}âŸ(fogDensityâŠ¸>)1
        }âŸr.key.PressedKey r.key.up
        
        {ğ•¤
            fogDensity -â†© 0.001
            {fogDensityâ†©ğ•©}âŸ(fogDensityâŠ¸<)0
        }âŸr.key.PressedKey r.key.down

        rf.SetShaderValueâŸ¨shader, fogDensityLoc, â‹ˆfogDensity, r.shaderUniformDataType.floatâŸ©

        # Rotate the torus
        donutModel â†© {
            (MatrixRotateZ 0.012) MPËœ ğ•© MP MatrixRotateX Â¯0.025
        }âŒ¾(4â€¿4â¥ŠmodelIndex.transformâŠ¸âŠ‘) donutModel

        # Update the light shader with the camera view position
        camPosIndex â† 0
        rf.SetShaderValueâŸ¨shader, âŠ‘1 rf.MakeI32 locsPtr rf.MovePtrËœ 4Ã—r.shaderLocationIndex.vector_view-1, â‹ˆâŠ‘camPosIndexâŠ‘camera, r.shaderUniformDataType.vec3âŸ©

        # Draw
        {ğ•¤
            {ğ•¤
                # Draw the models
                rf.DrawModelâŸ¨Print donutModel â‹„ 3â¥Š0 â‹„ 1 â‹„ r.color.whiteâŸ©
                #âˆ¾{
                #    âŸ¨donutModel â‹„  ğ•©  â€¿0â€¿2âŸ©
                #}Â¨2Ã—Â¯10+â†•20
            }r.draw._in3D camera

            rf.DrawTextâŸ¨"Use KEY_UP/KEY_DOWN to change fog density ["âˆ¾fogDensityâˆ¾".2f]"âˆ¾@, 10, 10, 20, r.color.raywhiteâŸ©
        }r.draw._withCanvas_ r.color.gray@
    }â€¢_while_(Â¬r.window.ShouldClose)@

    rf.UnloadModelÂ¨donutModelâ€¿cubeModelâ€¿sphereModel
    rf.UnloadTexture texture
    rf.UnloadShader  shader

} r.window._openAsËœâŸœ0.5 "raylib [shaders] example - fog"