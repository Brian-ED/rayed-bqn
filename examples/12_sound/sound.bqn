âŸ¨color
 draw
 key
 window
 rfâ‡rayffi
 rmâ‡raymath
âŸ©â†rlâ†â€¢Import "../../raylib.bqn"

âŸ¨SinâŸ© â† â€¢math

max_samples            â† 512
max_samples_per_update â† 4096

frequency â† 440      # Cycles per second (hz)
audioFrequency â† 440 # Audio frequency, for smoothing
oldFrequency â† 1     # Previous value, used to test if sine needs to be rewritten, and to smoothly modulate frequency
sineIdx â† 0          # Index for audio rendering

libname â† "callback.so"
setFreq      â† libnameâ€¢FFI ""â€¿"SetFreq"â€¿">f32"

#------------------------------------------------------------------------------------
# Program main entry point
#------------------------------------------------------------------------------------
{ğ•¤
    # Initialization
    #--------------------------------------------------------------------------------------
    
    rf.InitAudioDevice âŸ¨âŸ©
    font â† rl.font.LoadBQN@
    Text â† color.blackâ€¿fontâ€¿20âŠ¸rl.draw.Text

    rf.SetAudioStreamBufferSizeDefault max_samples_per_update

    
    # Init raw audio stream (sample rate: 44100, sample size: 16bit-short, channels: 1-mono)
    stream â† rf.LoadAudioStream 44100â€¿16â€¿1

    rf.SetAudioStreamCallback streamâ‹ˆ{ğ•âŸ¨âŸ©}libnameâ€¢FFI"*:i8"â€¿"GetCallbackPtr"

    # Buffer for the single cycle waveform we are synthesizing
    data â† 0Â¨â†•4Ã—max_samples

    rf.PlayAudioStream stream        # Start processing stream buffer (no data loaded currently)

    {ğ•¤
        # Update
        #----------------------------------------------------------------------------------

        # Sample mouse input.
        mouseXâ€¿mouseY â† rl.mouse.GetPos@
        widthâ€¿hight â† window.GetSize@

        {ğ•¤
            frequency â†© 40 + mouseY
            SetFreq frequency

            pan â† mouseXÃ·width
            rf.SetAudioStreamPan streamâ€¿pan
        }âŸâŠ¢rf.IsMouseButtonDown rl.mouse.button.left

        # Rewrite the sine wave
        # Compute two cycles to allow the buffer padding, simplifying any modulation, resampling, etc.
        {ğ•¤
            # Compute wavelength. Limit size in both directions.
            #int oldWavelength = waveLength;
            waveLength â† 22050âŒŠâˆ˜Ã·frequency

            wavelength (1âŒˆâŒŠ)â†© max_samplesÃ·2

            # Write sine wave
            {ğ•Ši:
                data {ğ•©âŒ¾(iâŠ¸âŠ‘)ğ•¨} â†© 32000Ã—â€¢math.Sin 2Ã—Ï€Ã—iÃ·waveLength
            }Â¨â†•âŒŠwaveLengthÃ—2
            
            # Scale read cursor's position to minimize transition artifacts
            #readCursor = (int)(readCursor * ((float)waveLength / (float)oldWavelength));
            oldFrequency â†© frequency
        }âŸâŠ¢frequency â‰  oldFrequency
        #----------------------------------------------------------------------------------
        # Draw
        #----------------------------------------------------------------------------------
        {ğ•¤
            Text âŸ¨
                âŸ¨300-ËœâŠ‘window.GetSize@ â‹„ 10âŸ©
                "sine frequency: "âˆ¾â€¢Repr frequency
            âŸ©
            Text 10â€¿10â‹ˆ"click mouse button to change frequency or pan"

            # Draw the current buffer state proportionate to the screen
            positions â† {
                ğ•©â‹ˆ250+50Ã—32000Ã·ËœdataâŠ‘ËœâŒŠğ•©Ã—max_samplesÃ·width
            }Â¨â†•width
            {rf.DrawPixelV ğ•©â€¿color.red}Â¨positions

        }draw._withCanvas_ color.raywhite@
        #----------------------------------------------------------------------------------
    }â€¢_while_(Â¬window.ShouldClose)@

    # De-Initialization
    #--------------------------------------------------------------------------------------
    rf.UnloadAudioStream stream   # Close raw audio stream and delete buffers from RAM
    rf.CloseAudioDevice  âŸ¨âŸ©       # Close audio device (music streaming is automatically stopped)

} rl.window._openAs "raylib [audio] example - raw audio streaming"