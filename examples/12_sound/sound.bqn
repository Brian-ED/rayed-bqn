âŸ¨color
 draw
 key
 window
 rfâ‡rayffi
 rmâ‡raymath
âŸ©â†rlâ†â€¢Import "../../raylib.bqn"

âŸ¨SinâŸ© â† â€¢math

max_samples_per_update â† 4096

frequency â† 440      # Cycles per second (hz)
audioFrequency â† 440 # Audio frequency, for smoothing
sineIdx â† 0          # Index for audio rendering

libname â† "callback.so"
setFreq      â† libnameâ€¢FFI ""â€¿"SetFreq"â€¿">f32"

#------------------------------------------------------------------------------------
# Program main entry point
#------------------------------------------------------------------------------------
{ğ•¤
    # Initialization
    #--------------------------------------------------------------------------------------
    
    rf.InitAudioDevice âŸ¨âŸ©
    font â† rl.font.LoadBQN@
    rf.SetAudioStreamBufferSizeDefault max_samples_per_update

    # Init raw audio stream (sample rate: 44100, sample size: 16bit-short, channels: 1-mono)
    stream â† rf.LoadAudioStream 44100â€¿16â€¿1

    rf.SetAudioStreamCallback streamâ‹ˆ{ğ•âŸ¨âŸ©}libnameâ€¢FFI"*:i8"â€¿"GetCallbackPtr"

    rf.PlayAudioStream stream        # Start processing stream buffer (no data loaded currently)

    # Update
    {ğ•¤
        # Events
        mouseXâ€¿mouseY â† rl.mouse.GetPos@
        widthâ€¿hight â† window.GetSize@
        leftPressed â† rf.IsMouseButtonDown rl.mouse.button.left
        {ğ•¤
            frequency â†© 0âŒˆmouseY
            SetFreq frequency

            pan â† Â¬0âŒˆ1âŒŠ mouseXÃ·width   # Ratio between left and right speaker (assumes you have directional speakers)
            rf.SetAudioStreamPan streamâ€¿pan

        }âŸâŠ¢leftPressed

        # current buffer state proportionate to the screen
        wave â† â€¢math.Sin widthâ†•âŠ¸Ã—frequencyÃ·widthÃ—10
        positions â† â‰widthâ†•âŠ¸â‰250+50Ã—wave

        {ğ•¤ # Draw
            color.blackâ€¿fontâ€¿20âŠ¸rl.draw.TextÂ¨âŸ¨
                âŸ¨width-300 â‹„ 10âŸ©â‹ˆ"sine frequency: "âˆ¾â€¢Repr frequency
                10â€¿10           â‹ˆ"click mouse button to change frequency or pan"
            âŸ©
            rf.DrawPixelVâˆ˜â‹ˆâŸœcolor.redË˜positions
        }draw._withCanvas_ color.raywhite@
    }â€¢_while_(Â¬window.ShouldClose)@

    # De-Initialization
    #--------------------------------------------------------------------------------------
    rf.UnloadAudioStream stream   # Close raw audio stream and delete buffers from RAM
    rf.CloseAudioDevice  âŸ¨âŸ©       # Close audio device (music streaming is automatically stopped)

} rl.window._openAs "raylib [audio] example - raw audio streaming"