âŸ¨color
 draw
 key
 window
 rfâ‡rayffi
 rmâ‡raymath
âŸ©â†rlâ†â€¢Import "../../raylib.bqn"

âŸ¨SinâŸ© â† â€¢math


# *******************************************************************************************
# 
#    raylib [audio] example - Raw audio streaming
# 
#    Example originally created with raylib 1.6, last time updated with raylib 4.2
# 
#    Example created by Ramon Santamaria (@raysan5) and reviewed by James Hofmann (@triplefox)
# 
#    Example licensed under an unmodified zlib/libpng license, which is an OSI-certified,
#    BSD-like license that allows static linking with closed source software
# 
#    Copyright (c) 2015-2023 Ramon Santamaria (@raysan5) and James Hofmann (@triplefox)
# 
# *******************************************************************************************/

max_samples            â† 512
max_samples_per_update â† 4096

frequency â† 440      # Cycles per second (hz)
audioFrequency â† 440 # Audio frequency, for smoothing
oldFrequency â† 1     # Previous value, used to test if sine needs to be rewritten, and to smoothly modulate frequency
sineIdx â† 0          # Index for audio rendering

libname â† "callback.so"
setAudioInputCallback â† libnameâ€¢FFI "*:i8"â€¿"SetAudioInputCallback"â€¿">a" # a here is func

# Audio input processing callback
AudioInputCallback â† {ğ•Šbuffer:
    audioFrequencyÃ—âŸœ0.95âŒ¾(-âŸœfrequency)â†©
    incr â† audioFrequencyÃ·44100
    âŒŠ{ğ•¤
        n â† 32000Ã—Sin 2Ã—Ï€Ã—sineIdx
        sineIdx +â†© incr
        {sineIdx -â†© 1}âŸâŠ¢sineIdx>1
        n
    }Â¨buffer
}
audioInputCallbackPtr â† SetAudioInputCallback audioInputCallback

#------------------------------------------------------------------------------------
# Program main entry point
#------------------------------------------------------------------------------------
{ğ•¤
    # Initialization
    #--------------------------------------------------------------------------------------
    
    rf.InitAudioDevice âŸ¨âŸ©
    font â† rl.font.LoadBQN@
    Text â† color.blackâ€¿fontâ€¿20âŠ¸rl.draw.Text

    rf.SetAudioStreamBufferSizeDefault max_samples_per_update

    
    # Init raw audio stream (sample rate: 44100, sample size: 16bit-short, channels: 1-mono)
    stream â† rf.LoadAudioStream 44100â€¿16â€¿1

    rf.SetAudioStreamCallback streamâ€¿audioInputCallbackPtr

    # Buffer for the single cycle waveform we are synthesizing
    data â† 0Â¨â†•4Ã—max_samples

    rf.PlayAudioStream stream        # Start processing stream buffer (no data loaded currently)

    {ğ•¤
        # Update
        #----------------------------------------------------------------------------------

        mousePosition â† rl.mouse.GetPos@
        widthâ€¿hight â† window.GetSize@

        {ğ•¤
            fp â† 1âŠ‘mousePosition
            frequency â†© 40 + fp

            pan â† mousePositionâŠ‘âŠ¸Ã·width
            rf.SetAudioStreamPan streamâ€¿pan
        }âŸâŠ¢rf.IsMouseButtonDown rl.mouse.button.left

        # Rewrite the sine wave
        # Compute two cycles to allow the buffer padding, simplifying any modulation, resampling, etc.
        {ğ•¤
            # Compute wavelength. Limit size in both directions.
            #int oldWavelength = waveLength;
            waveLength â† 22050âŒŠâˆ˜Ã·frequency

            wavelength (1âŒˆâŒŠ)â†© max_samplesÃ·2

            # Write sine wave
            {ğ•Ši:
                data {ğ•©âŒ¾(iâŠ¸âŠ‘)ğ•¨} â†© 32000Ã—â€¢math.Sin 2Ã—Ï€Ã—iÃ·waveLength
            }Â¨â†•âŒŠwaveLengthÃ—2
            
            # Scale read cursor's position to minimize transition artifacts
            #readCursor = (int)(readCursor * ((float)waveLength / (float)oldWavelength));
            oldFrequency â†© frequency
        }âŸâŠ¢frequency â‰  oldFrequency
        #----------------------------------------------------------------------------------
        # Draw
        #----------------------------------------------------------------------------------
        {ğ•¤
            Text âŸ¨
                10âˆ¾Ëœ300-Ëœwidth
                "sine frequency: "âˆ¾â€¢Repr frequency
            âŸ©
            Text âŸ¨10â‹„10âŸ©â€¿"click mouse button to change frequency or pan"

            # Draw the current buffer state proportionate to the screen
            {
                position â† âŸ¨
                    ğ•©
                    250 + 50Ã—32000Ã·ËœdataâŠ‘ËœâŒŠğ•©Ã—max_samplesÃ·width
                âŸ©
                rf.DrawPixelV positionâ€¿color.red
            }Â¨â†•âŒŠwidth

        }draw._withCanvas_ color.raywhite@
        #----------------------------------------------------------------------------------
    }â€¢_while_(Â¬window.ShouldClose)@

    # De-Initialization
    #--------------------------------------------------------------------------------------
    rf.UnloadAudioStream stream   # Close raw audio stream and delete buffers from RAM
    rf.CloseAudioDevice  âŸ¨âŸ©       # Close audio device (music streaming is automatically stopped)

} rl.window._openAs "raylib [audio] example - raw audio streaming"