âŸ¨câ‡color,window,draw,kâ‡keyâŸ©â†râ†â€¢Import "../../rayed.bqn"

lf â† @+10

# level example
##############
#            #
#   ######o  #
#            #
#            #
#  >   /     #
#  #   @     #
##############

# the characters that are used in the level representation
âŸ¨
  empty, player, goalOff, wall, lMirror
  rMirror, lLaser, rLaser, uLaser, dLaser
âŸ©â‡â†•â‰ charsâ†" @o#\/<>^v"

goalOnâ€¿ubeamâ€¿hbeamâ€¿vbeamâ€¿xbeamâ†5â†•âŠ¸+â‰ chars
lasers â† ulaserâ€¿llaserâ€¿dlaserâ€¿rlaser
dirs â† âŸ¨Â¯1â€¿0â‹„0â€¿Â¯1â‹„1â€¿0â‹„0â€¿1âŸ©
dirLetters â† "wasd"
mirrors â† lmirrorâ€¿rmirror
scale â† 10

levels â† charsâŠ¸âŠâˆ˜>Â¨((+`Ã—Â¬)âŠ¸-0=â‰ Â¨)âŠ¸âŠ”â€¢FLines "levels.txt"

colorsRGBAâ€¿colorNames â† {ğ•©âŠ¸â€¢ns.GetÂ¨âŠ¸â‹ˆâ€¢ns.Keysğ•©}r.color

txtFile â† "sprites.txt"
pencils â† {ğ•©âŠ¸draw.Rectangle}Â¨colorsRGBA


colorMappedTextures â† {
  nameâ€¿colorString â† 2â†‘ğ•©
  colorsPicked â† (+`Ã—Â¬)âŠ¸-âˆ˜=âŸœ' 'âŠ¸âŠ” (32Ã—1="A["âŠ¸â‹)âŠ¸+colorString
  cMapped â† 1âŒ½11â†‘colorNamesâŠâŸ¨"transparent"âŸ©âˆ¾colorsPicked
  {ğ•Š:!âˆ¾âŸ¨
    "Invalid color found in "â‹„txtFile
    " (color â‰¡ "â‹„colorsPickedâŠ‘ËœâŠ‘â’Â¯1â†“cmappedâ‹„")"
  âŸ©}âŸâŠ¢colorNamesâ‰ âŠ¸=âŒˆÂ´Â¯1â†“cMapped
  cMappedâŠËœ('0'+â†•10)âŠ>2â†“ğ•©
}Â¨((+`Ã—Â¬)âŠ¸-0=â‰ Â¨)âŠ¸âŠ” â€¢FLines txtFile

DrawBoard â† {
  {pensğ•ŠspotMajor:
    {penğ•ŠspotMinor:
      penâ—¶pencils 100+scaleÃ—+`1â€¿1â‰ËœâŒ½spotMinor+spotMajorÃ—5
    }Â¨âŸœ(â†•â‰¢)pens
  }Â¨âŸœ(â†•â‰¢)ğ•©âŠcolorMappedTexturesâˆ¾Ëœ<â†•0â€¿0
}âŠ¸âŠ¢

DrawLaser â† {levelğ•Šstart:
  directionIndex â† âŠ‘lasersâŠstartâŠ‘level
  !directionIndex<â‰ lasers
  direction â† dirsâŠ‘ËœdirectionIndex
  direction {
    empty=ğ•©âŠ‘level?
      c.redâŠ¸draw.RectangleÂ¨ 100+scaleÃ—(+`1â€¿1â‰ËœÂ·âŒ½(5Ã—ğ•©)âŠ¸+)Â¨/â—‹â¥ŠâŸœ(â†•â‰¢)â‰âŸ(Â¬âˆ¨Â´"da"=(âŠ‘(<ğ•¨)âŠËœdirs)âŠ‘dirLetters)2=âŠ‘Â¨â†•5â€¿5
      ğ•¨ğ•Šğ•¨+ğ•©
  ; rMirror=ğ•©âŠ‘level?
      side â† âŠ‘ğ•¨<âŠ¸âˆŠâŸ¨0â€¿1â‹„1â€¿0âŸ©
      c.redâŠ¸draw.RectangleÂ¨ 100+scaleÃ—(+`1â€¿1â‰ËœÂ·âŒ½(5Ã—ğ•©)âŠ¸+)Â¨/â—‹â¥ŠâŸœ(â†•â‰¢)(âŒ½Ë˜âŒ½)âŸ(Â¬side)2=âŒˆâŒœËœâ†•5
      newDir â† -âŒ½ğ•¨
      newDirğ•ŠnewDir+ğ•©
  ; lMirror=ğ•©âŠ‘level?
      side â† âŠ‘ğ•¨<âŠ¸âˆŠâŸ¨0â€¿1â‹„Â¯1â€¿0âŸ©
      c.redâŠ¸draw.RectangleÂ¨ 100+scaleÃ—(+`1â€¿1â‰ËœÂ·âŒ½(5Ã—ğ•©)âŠ¸+)Â¨/â—‹â¥ŠâŸœ(â†•â‰¢)(âŒ½Ë˜âŒ½)âŸ(Â¬side)âŒ½2=âŒˆâŒœËœâ†•5
      newDir â† âŒ½ğ•¨
      newDirğ•ŠnewDir+ğ•©
  ;
    goalOff=ğ•©âŠ‘level
  } direction+start
}

OnStart â† {ğ•¤

  # Definitions

  fontâ†r.font.LoadBQN 100
  DT â† âŸ¨c.whiteâ‹„fontâ‹„30âŸ© draw.Text â‹ˆâŸœ((Â»âŠ¸âˆ¨â‰ âŸœ' ')âŠ¸/)

  _Scene_ â† {ğ”½ draw._withCanvas_ c.black â€¢_While_ (window.ShouldClose<ğ”¾)}

  StartScreen â† DTÂ´Â¨âˆ˜âŸ¨
    30â€¿30â‹ˆ"Power the machines by moving the mirrors"
    30â€¿60â‹ˆ"Controls: wasd to move, r to reset level"
  âŸ©âŠ¸âŠ¢ _Scene_ (@â‰¡k.PressedChar)

  MiddleScreen â† DTÂ´Â¨âˆ˜âŸ¨
    300â€¿300â‹ˆ"Good job!"
    300â€¿330â‹ˆ"Press any key to continue to the next level!"
  âŸ©âŠ¸âŠ¢ _Scene_ (@â‰¡k.PressedChar)

  EndScreen â† DTÂ´Â¨âˆ˜âŸ¨
    300â€¿300â‹ˆ"Congratulations!!"
    300â€¿330â‹ˆ"You're done with the game, thanks for playing! :)"
    300â€¿360â‹ˆ"Press any key to restart"
  âŸ©âŠ¸âŠ¢ _Scene_ (@â‰¡k.PressedChar)

  StartScreen@

  {levelNumberğ•Šlevel:
    0â€¿0 DT "Level "âˆ¾â€¢Repr 1+levelNumber
    key â† k.PressedChar@
    hit â† DrawBoard level
    outâ†{
      âŠ‘keyâˆŠdirLetters? # movement
        move â† dirsâŠ‘ËœâŠ‘dirLettersâŠkey
        relivants â† (moveÃ—âŒœâ†•3) + âŠ‘ /â—‹â¥ŠâŸœ(â†•â‰¢) 1=level
        {playerâ€¿spaceInfrontâ€¿spaceAfterFront:
          {spaceInfront=empty?
            spaceInfrontâ€¿playerâ€¿spaceAfterFront
          ; âˆ§Â´âŸ¨âˆ¨Â´spaceInfront=mirrorsâ‹„spaceAfterFront=emptyâŸ©?
            emptyâ€¿playerâ€¿spaceInfront
          ;
            ğ•©
          }ğ•©
        }âŒ¾((<Ë˜â‰relivants|Ëœâ‰¢level)âŠ¸âŠ‘) level
    ; keyâ‰¡'r'?
        levelNumberâŠ‘levels
    ;
      level
    }
    won â† âˆ§Â´outâŠ¸DrawLaserÂ¨/â—‹â¥ŠâŸœ(â†•â‰¢)levelâˆŠlasers

    outâŸÂ¬won
  } _Scene_ (2==âˆ˜âŠ¢) {MiddleScreenâˆ˜ğ”½}Â¨ËœâŸœ(â†•â‰ )levels

  EndScreen@

  r.font.Unload font
}

OnStart window._openAs "Arc"