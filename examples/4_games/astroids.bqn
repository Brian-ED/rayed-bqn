# MIT License
# Copyright (c) 2024 David Zwitser
âŸ¨câ‡color, winâ‡window, font, dâ‡draw, mâ‡mouse, key, rayffiâ‡raylibâŸ©â†râ†â€¢Import "../../rayed.bqn"
Sinâ€¿Cos â† â€¢math

frame â† time â† dt â† deltatime â† 1
center â† wâ€¿h â† size â† 0â€¿0

states â† {startâ€¿playâ€¿resetâ€¿dying â‡ â†•4}

Lfo â† {ğ•Š stepâ€¿size:
  size Ã— Sin time Ã— step Ã— Ï€Ã·2
}

Rand â† {ğ•Šrange: â€¢rand.RangeÂ¨ğ•©;
  	 resğ•Šrange: â€¢rand.RangeÂ¨âŒ¾(resâŠ¸Ã—)ğ•©
}

Player â† {type â‡ ğ•¤
  pos â† center, vel â† 0â€¿0, rot â† 0, life â‡ 3
  rocket_power â† 0.05, rot_speed â† 0.02, size â† 20, fric â† 0.995
  color â† c.white
  boosting â† 0

  base_shape â† â‰[0.2â€¿0.3, 0â€¿0, 0.5â€¿1.5, 1â€¿0, 0.8â€¿0.3]
  base_flame â† â‰[0.5â€¿Â¯0.2, 0.2â€¿0.3, 0.8â€¿0.3]
  base_center â† (+ËÃ·â‰ )â‰base_shape
  draw_shape â† base_shape

  Orient â‡ {ğ•Š: rot +â†© Ï€Ã—rot_speedÃ—ğ•©}
  Boost  â‡ {
		{
			vel +â†© rocket_power Ã— ğ•©Ã—-âˆ˜SinâŠ¸â‹ˆâŸœCos rot
		}âŸâŠ¢ boosting â†© ğ•©
	}
  GetBulletInfo  â‡ {ğ•Š: rotâ‹ˆËœ2âŠË˜draw_shape}

  Update â‡ {ğ•Š: pos ({xâ€¿y: (w|x)â€¿(h|y)}+)â†© vel, vel Ã—â†© fric }
  ShapeShape â† {posâŠ¸+Ë˜ sizeâŠ¸Ã— (SinâŠ¸(â‹ˆËœâ‰-âŠ¸â‹ˆ)âŸœCos rot)+Ëâˆ˜Ã—â‰2â€¿1 -âŸœğ•¨Ë˜ ğ•©}

  Draw â‡ {ğ•Š:
    draw_shape â†© â‰base_center ShapeShape â‰base_shape
		c.white d.Line â‰Ë˜â‰1âŠ¸âŒ½âŠ¸â‰ â‰draw_shape

    {ğ•Š:
      draw_flame â† base_center ShapeShape â‰base_flame
    	c.white d.Line â‰Ë˜â‰1âŠ¸âŒ½âŠ¸â‰ draw_flame
      ;@
    }âŸâŠ¢boosting âˆ§ 5<10|frame
  }
  CollBody â‡ {ğ•Š: draw_shape}
  Hit â‡ {ğ•Š: life (4|-)â†© 1, velâ†©0â€¿0}
  Dying â‡ {ğ•Š: color â†© (10>20|frame)âŠ‘âŸ¨c.white,c.blackâŸ©}
  CenterMe â‡ {ğ•Š: posâ†©center}
}

Astroid â† {ğ•Šinfo: type â‡ ğ•¤
  life â‡ 1
  max_size â† 6, scale â† 10
  sizeâ€¿pos â† {infoâ‰¡@ ?
      âŸ¨1 + â€¢rand.Range max_size - 1
       center+100 + Rand wâ€¿hâŸ©
    ; info
  }
  vel â† 0.7Ã—{(ğ•©Ã·2)-Ëœ1000 Randâ‹ˆËœğ•©} max_size-size

  CreateShape â† {ğ•Š v_countâ€¿off_chanceâ€¿off_size:
    Circle â† {-âˆ˜SinâŠ¸â‹ˆâŸœCosÂ¨ ğ•©Ã·ËœÏ€Ã—2 Ã— 1+ â†•ğ•©}
    {ğ•© - (10 Randâ‹ˆËœ off_size) Ã— 0â‰¡â€¢rand.Range off_chance }Â¨  Circle v_count
  }
  shape â† >scaleÃ—size Ã— CreateShape 10â€¿3â€¿0.8
  shape_center â† (+ËÃ·â‰ ) shape

  Update â‡ {ğ•Š: pos (wâ€¿h|+) â†© vel}

  Draw â‡ {ğ•Š:
    draw_shape â† pos +â‰1 shape
    c.white d.Line â‰Ë˜â‰1âŠ¸âŒ½âŠ¸â‰ draw_shape
  }
  CollBody â‡ {ğ•Š: (pos+shape_center)â€¿(scaleÃ—size) }
  Split â‡ {ğ•Š: life â†© 0, â‹ˆËœ(size-1)â€¿pos}
}
Bullet â† {posâ€¿vel: type â‡ ğ•¤
  life â‡ 1
  size â† 2

  Update â‡ {ğ•Š: pos +â†© vel}
  Draw   â‡ {ğ•Š: c.white d.Rectangle âŒŠpos (-â‰+)âˆ¾Ëœ sizeÃ·2}
  CollBody â‡ {ğ•Š: posâ‰2â¥Šsize}
  Kill â‡ {ğ•Š: life â†© 0}
}

_getUI â† {font _ğ•£ lives:
  c.whiteâ€¿fontâ€¿30 d.Text âŸ¨wâ€¿hÃ—0.01â‹„livesâˆ¾" lives"âŸ©
}

Resize â† {ğ•Š world:
  wâ€¿h â†© size â†© win.GetSize@, center â†© sizeÃ·2
}
Input â† {ğ•Š world:
  playerâ†âŠ‘world
  {key.IsDown key.right ? player.Orient 1; @}
  {key.IsDown key.left ? player.Orient Â¯1; @}
  {key.IsDown key.up ? player.Boost 1; player.Boost 0}
  {key.IsPressed key.space ?
    posâ€¿rot â† player.GetBulletInfo @
    world âˆ¾â†©Bullet posâ‹ˆ7Ã—-âˆ˜SinâŠ¸â‹ˆâŸœCos rot
    ; @
  }
  world
}
Collision â† {ğ•Š stateâ€¿world:
  bullets â† {ğ•© âŠ‘ world}Â¨ / {ğ•©.type â‰¡ bullet}Â¨ world
  astroids â† {ğ•© âŠ‘ world}Â¨ / {ğ•©.type â‰¡ astroid}Â¨ world
  player â† âŠ‘world

  new_astroids â† âŸ¨âŸ©
  BullHit â† {bullet ğ•Š astroid:
    rayffi.CheckCollisionCircleRec ğ•©.CollBodyâŠ¸âˆ¾<ğ•¨.CollBody@?
      bullet.Kill @
      new_astroids âˆ¾â†© astroid.Split @
    ; @
  }
  bullets BullHitâŒœ astroids
  world âˆ¾â†© AstroidÂ¨ new_astroids

  PlayerHit â† {playerğ•Šastroid:
    p_points â† player.CollBody @
    a_bod â† astroid.CollBody @
    +Â´ {rayffi.CheckCollisionPointCircle ğ•©<âŠ¸âˆ¾a_bod}Ë˜ â‰p_points
  }
  player_is_hit â† 0 < +Â´ player PlayerHitâŒœ astroids
  {player_is_hit ? player.Hit @, stateâ†©states.dying;@}
  {player.life â‰¡ 0 ? state â†© states.reset ;@}

  stateâ€¿world
}

Run â† {stateâ€¿worldâ€¿fontBQNâ€¿DrawUI:
  {state â‰¡ states.start ?
    size â† 40
    {
      (150|frame)>50?
      c.whiteâ€¿fontBQNâ€¿size d.Text {(center - (size Ã— 0.5Ã— â‰ ğ•©)â€¿sizeÃ·2)â€¿ğ•©} "space to sâ†‘art"
      ;@
    }
    {key.IsDown key.space ? state â†© states.play, frameâ†©0 ; @}

    stateâ€¿world
  ; state â‰¡ states.play ?

    {ğ•©.Draw @}Â¨ world
    { frame<200?
      size â† 40
      c.whiteâ€¿fontBQNâ€¿size d.Text {(center - (size Ã— 0.5Ã— â‰  ğ•©)â€¿sizeÃ·2)â€¿ğ•©} â€¢Fmt âŒˆ3-3Ã—frameÃ·200
      ;
      world Inputâ†©
      world {0<ğ•©.life}Â¨âŠ¸/ â†©
      {ğ•©.Update @}Â¨ world
    }
    DrawUI â€¢Fmt (âŠ‘world).life

    {(+Â´{ğ•©.typeâ‰¡astroid}Â¨world)â‰¡0?worldâˆ¾â†©(Astroid 0);@}

    stateâ€¿world Collisionâ†©
    {state â‰¡ states.dying ? frameâ†©0; @}

    stateâ€¿world

  ; state â‰¡ states.dying ?
    {frame < 100 ?
      DrawUI â€¢Fmt (âŠ‘world).life
      (âŠ‘world).Dying @
      {ğ•©.Draw@}Â¨ world
      stateâ€¿world
    ;
      (âŠ‘world).CenterMe@
      # world â†© CreateWorld 10â€¿(âŠ‘world)
      state â†© states.play
      stateâ€¿world
    }

  ; state â‰¡ states.reset ?
    world â†© CreateWorld 10â€¿@
    state â†© states.start
    stateâ€¿world
  ;stateâ€¿world}
}

CreateWorld â† {ğ•Š astroid_amountâ€¿prev_player:
  {prev_playerâ‰¡@? prev_player â†© Player @; @}
  astroids â† AstroidÂ¨ astroid_amountâ¥Š@
  prev_playerâˆ¾astroids
}

{ğ•Š:
  Resize âŸ¨âŸ©
  fontBQN â† font.LoadBQN 80
  DrawUI â† fontBQN _getUI
  {ğ•Š stateâ€¿world:
    frame +â†© 1, time +â†© dt â† deltatime â† rayffi.GetFrameTimeâŸ¨âŸ©
    { rayffi.IsWindowResizedâŸ¨âŸ© ? Resize world ; @}

    rayffi.DrawFPS 20â€¿50
    Run stateâ€¿worldâ€¿fontBQNâ€¿DrawUI
  } d._withCanvasâŸœc.black â€¢_While_ (Â¬win.ShouldClose) states.resetâ€¿âŸ¨âŸ©
} win._openAs "Astroids"
