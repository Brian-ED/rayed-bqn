# My highscore is 124... beat that!

âŸ¨câ‡color,window,draw,kâ‡keyâŸ©â†râ†â€¢Import "../../rayed.bqn"
textSize â† 100
size â† 15

nonDarkModeâ€¿darkMode â† {
  âŸ¨text, fruit, snake, lines, backgroundâŸ© â‡ ğ•©
}Â¨{
  yellow â† 255â€¿200â€¿0â€¿255
  âŸ¨c.blackâ€¿c.redâ€¿c.blue â€¿c.whiteâ€¿yellow
   âŒˆ1.3Ã·Ëœc.whiteâ€¿c.redâ€¿c.greenâ€¿c.whiteâ€¿c.blackâŸ© # divided to lower intencity
}

Game â† {ğ•Š:
  # Constants
  winSize       â† window.GetSize@
  textPixelSize â† r.raylib.MeasureTextÂ¨textSizeâ‹ˆËœÂ¨"Paused"â€¿"GAME OVER"
  tileSize      â† âŒŠwinSizeâŒŠÂ´âŠ¸Ã·size+2
  lines         â† â‰Â´Ë˜âŒ½Â¨âŠ¸âˆ¾(âŠ¢âˆ¾âŒœ2â†‘1âŒ½â¼âŠ¢)tileSizeÃ—1+â†•1+size # Line drawing positions
  font          â† r.font.LoadBQN 100

  sâ†âŸ¨âŸ©

  i â† {
    f â† {
      iâ†Â¯1
      {sâˆ¾â†©<ğ•© â‹„ i+â†©1}
    }
    gameState â‡ F 1 # 0 is gameOver, 1 is playing, 2 is paused
    frame â‡ F 0
    snake â‡ F [0â€¿0] # List of xâ€¿y positions of the snake
    fruit â‡ F 2 â€¢rand.Range size

    # 0â€¿1 up, 1â€¿0 right, 0â€¿Â¯1 down, Â¯1â€¿0 left
    # first in list is the current facing, pressing right 1âŒ½ pressing left 1âŒ½â¼
    facing â‡ F [1â€¿0, 0â€¿Â¯1, Â¯1â€¿0, 0â€¿1]

    speed â‡ F 10
    keyBuffer â‡ F â†•0 # buffer for key presses in a game-frame
    keyBufferCatchUp â‡ F â†•0 # buffer for key presses that leak to next game-frame
    palete â‡ F nonDarkMode
  }

  PerGameFrame â† {ğ•ŠgameStateâ€¿snakeâ€¿fruitâ€¿facingâ€¿keyBufferâ€¿keyBufferCatchUp:
    newBuffer â† keyBufferCatchUpâˆ¾âŒ½keyBuffer
    SpawnFruit    â† {â€¢rand.Rangeâˆ˜â‰ âŠ¸âŠ‘(<Ë˜ğ•¨)(Â¬âˆ˜âˆŠËœ/âŠ¢)â¥Šâ†•2â¥Šsize}
    nowFacing     â† facingâŒ½Ëœ-Â´k.leftâ€¿k.right=âŠ‘Â¯1â†‘newBuffer
    extendedSnake â† nowfacing(âŠ¢âˆ¾Ëœsize|+â—‹âŠ)snake
    newFruit      â† extendedSnake SpawnFruitâŸ(âŠâŠ¸â‰¡) fruit
    cutSnake      â† Â¯1âŠ¸â†“âŸ(newFruitâ‰¡fruit)extendedSnake
    âŸ¨
      gameStateÃ—â·âŠ¸â‰¡cutSnake # gameState
      cutSnake              # snake
      newFruit              # fruit
      nowFacing             # facing
      â†•0                    # reset game-frame keybuffer
      Â¯1â†“newBuffer          # consume inputted key
    âŸ©
  }âŒ¾(i.gameStateâ€¿i.snakeâ€¿i.fruitâ€¿i.facingâ€¿i.keyBufferâ€¿i.keyBufferCatchUpâŠ¸âŠ)

  PerFrame â† {ğ•Š:
    palâ€¿speedâ€¿frameâ€¿fruit â† i.paleteâ€¿i.speedâ€¿i.frameâ€¿i.fruitâŠğ•©
    pauseP â† k.right_shift = key â† k.PressedKey@
    {ğ•Š:
      pal.textâ€¿fontâ€¿40 draw.Text 10â€¿10â‹ˆâ€¢Repr Â¯1+â‰ i.snakeâŠ‘ğ•©
      i.gameStateâŠ¸âŠ‘â—¶âŸ¨ # each function is one scene
        {ğ•Š: # Game over screen
          pal.textâ€¿fontâ€¿textSize draw.Text "GAME OVER"â‹ˆËœ2â¥Š2Ã·ËœwinSize-1âŠ‘textPixelSize
          palâŒ¾(i.paleteâŠ¸âŠ‘) sâŸpauseP ğ•© # reset when pause is pressed
        }
        PerGameFrameâŸ(1=speed|frame) {ğ•Š: # Snake moving
          c.whiteâŠ¸draw.LineË˜lines
          pal.fruit draw.Rectangle +`(1+tileSizeÃ—1+fruit)â‰2â¥ŠtileSize-2
          pal.snakeâŠ¸draw.RectangleË˜(tileSize-2)(+â‰âŠ¢)Ë˜1+tileSizeÃ—1+i.snakeâŠ‘ğ•©
          {ğ•Šfâ€¿sâ€¿b:âŸ¨
            f+1
            2âŒˆs+-Â´key=k.downâ€¿k.up
            âˆ¾âŸœkeyâŸ(âŠ‘keyâˆŠk.leftâ€¿k.right) b
          âŸ©}âŒ¾(i.frameâ€¿i.speedâ€¿i.keyBufferâŠ¸âŠ)ğ•©
        }
        {ğ•Š: # Pause screen
          pauseTextâ†"Paused, d for dark"
          pal.textâ€¿fontâ€¿textSize draw.Text (2Ã·ËœwinSize-textPixelSizeâŠ‘âŠ¸âˆ¾textSize)â€¿pauseText
          {ğ•©â‰¡nonDarkMode?darkMode;nonDarkMode}âŒ¾(i.paleteâŠ‘âŠ¢)âŸ(key=k.d)ğ•©
        }
      âŸ© {1:2;2:1;ğ•©}âŸpausePâŒ¾(i.gameStateâŠ¸âŠ‘) ğ•©
    }draw._withCanvasâŸœpal.background ğ•©
  }

  PerFrameâ€¢_While_(Â¬window.ShouldClose)s
}
Game window._openAs "Snake"
