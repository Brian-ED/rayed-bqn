âŸ¨color
 draw
 key
 rfâ‡rayffi
âŸ©â†rlâ†â€¢Import "../../raylib.bqn"
rmâ†â€¢Import "../../src/raymath.bqn"

# intersection using the slab method
# https:#tavianator.com/2011/ray_box.html#:~:text=The%20fastest%20method%20for%20performing,remains%2C%20it%20intersected%20the%20box.

RayIntersectRectâ†{
    ğ•ŠâŸ¨
        xâ€¿yâ€¿widthâ€¿height # v4
        origin    # v2
        direction # v2
    âŸ©:

    minParam â† Â¯âˆ
    maxParam â† âˆ
    mon â† ğ•¨0âŠ˜1ğ•©
    {ğ•¤
        txMin â† (âŠ‘direction) Ã·Ëœ (âŠ‘origin) -Ëœ x
        txMax â† (âŠ‘direction) Ã·Ëœ (âŠ‘origin) -Ëœ x + width  

        minParam âŒˆâ†© txMin âŒŠ txMax
        maxParam âŒŠâ†© txMin âŒˆ txMax
    }âŸâŠ¢0â‰¢âŠ‘direction
    {ğ•¤
        tyMin â† (1âŠ‘direction) Ã·Ëœ (1âŠ‘origin) -Ëœ y
        tyMax â† (1âŠ‘direction) Ã·Ëœ (1âŠ‘origin) -Ëœ y + height

        minParam âŒˆâ†© tyMinâŒŠtyMax
        maxParam âŒŠâ†© tyMinâŒˆtyMax
    }âŸâŠ¢0â‰¢1âŠ‘direction
    {
        maxParam < 0?0;        # if maxParam < 0, ray is intersecting AABB, but the whole AABB is behind us
        minParam > maxParam?0; # if minParam > maxParam, ray doesn't intersect AABB
        mon? 1 âˆ¾ origin + direction Ã— minParam
        ;1
    }
}

CheckCollisionRay2dCircle â† {
    intersectionğ•ŠâŸ¨ # v2
        origin     # v2
        direction  # v2
        center     # v2
        radius     # f
    âŸ©:
    mon â† (ğ•¨0âŠ˜1ğ•©)
    intersectionâŠ¸â‹ˆ { rf.CheckCollisionPointCircle originâ€¿centerâ€¿radius?
        1âŠ£{ğ•Š:intersection â†© origin}âŸmon@
    ;
        vecToCenter â† center - origin
        dot â† +Â´vecToCenterÃ—direction
        {dot<0 ? 0;
            nearest â† origin + direction Ã— dot

            nearestToCenter â† center - nearest
            distSq          â† +Â´nearestToCenterâ‹†2

            distSq â‰¤ radius Ã— radius ?
            1âŠ£{ğ•¤
                nearestDist â† âˆšÂ´Ã—Ëœcenter-nearest
                b â† âˆšÂ´-Â´radiusâ€¿nearestDistâ‹†2
                intersection â†© origin + direction Ã— dot - b
            }âŸâŠ¢Â¬mon
            ;0
        }
    }
}

{ğ•¤
    rect â† 100â€¿100â€¿200â€¿50
    origin â† 450â€¿300
    direction â† 0â€¿Â¯1
    center â† 600â€¿200
    radius â† 50

    # Main game loop
    {ğ•¤
        angleDelta â† 90Ã—rf.GetFrameTimeâŠ¸Ã—-Â´rf.IsKeyDownÂ¨key.leftâ€¿key.right
        intersect â† 0â€¿0
        direction â†© rm.Vector2Transform directionâ‹ˆrm.MatrixRotateZ angleDelta Ã— Ï€Ã·180

        hit â† RayIntersectRect rectâ€¿originâ€¿direction

        rf.DrawRectangleRec rect â‹ˆ color.redâŸhit color.gray
        rf.DrawCircleV originâ€¿10â€¿color.yellow

        rf.DrawCircleVâŸhit intersectâ€¿5â€¿color.green

        rf.DrawCircleVÂ¨(âŠ¢Â´intersectâ€¿Â·â†©intersect CheckCollisionRay2dCircle originâ€¿directionâ€¿centerâ€¿radius)âŠ‘âŸ¨
            âŸ¨centerâ€¿radiusâ€¿color.grayâŸ©
            âŸ¨
                centerâ€¿radiusâ€¿color.red
                centerâ€¿2â€¿color.white
                intersectâ€¿5â€¿color.green
            âŸ©
        âŸ©
        rf.DrawLineVâŸ¨origin, origin+directionÃ—500, color.blueâŸ©
    } draw._withCanvas_ color.black â€¢_while_ (Â¬rl.window.ShouldClose) @
} rl.window._openAs "raylib extras [Math2d] example - ray rect intersection"