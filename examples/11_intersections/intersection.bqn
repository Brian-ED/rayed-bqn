âŸ¨color
 draw
 key
 rfâ‡rayffi
âŸ©â†rlâ†â€¢Import "../../raylib.bqn"
rmâ†â€¢Import "../../src/raymath.bqn"

# intersection using the slab method
# https:#tavianator.com/2011/ray_box.html#:~:text=The%20fastest%20method%20for%20performing,remains%2C%20it%20intersected%20the%20box.

RayIntersectRectâ†{
  ğ•ŠâŸ¨
    box       # [v2,v2]
    origin    # v2
    direction # v2
  âŸ©:
  minParamâ€¿maxParam â† âŒˆÂ´âŠ¸â‹ˆâŸœ(âŒŠÂ´)Â´<Ë˜â‰{ğ•Šdirâ€¿oriâ€¿posâ€¿siz:
    (âŒŠÂ´â‹ˆâŒˆÂ´) dirÃ·Ëœposâ€¿siz-ori
  }Ë˜â‰[direction,origin]âˆ¾â‰box

  intersectionâ†âˆâ€¿âˆ
  {ğ•Š:intersection}âŠ¸âŠ£{
    maxParam < 0?0;        # if maxParam < 0, ray is intersecting AABB, but the whole AABB is behind us
    minParam > maxParam?0; # if minParam > maxParam, ray doesn't intersect AABB
    intersectionâ†©origin + direction Ã— minParam
    1
  }
}

CheckCollisionRay2dCircle â† {
  ğ•ŠâŸ¨
    origin     # v2
    direction  # v2
    center     # v2
    radius     # f
  âŸ©:
  {
    rf.CheckCollisionPointCircle originâ€¿centerâ€¿radius?
      origin
  ; 
    dot â† 0âŒˆ+Â´directionÃ—center-origin
    Nearest â† origin+directionÃ—âŠ¢
    (+Â´âŒ¾(Ã—Ëœ)center-Nearest dot){
      Nearest dot--Â´âŒ¾(Ã—Ëœ)radiusâ‹ˆğ•¨
    }âŸ(â‰¤âŸœradius)ğ•©
  }âˆâ€¿âˆ
}
{ğ•¤
  box â† [100â€¿300,
         100â€¿150]
  origin â† 450â€¿300
  direction â† 0â€¿Â¯1
  center â† 600â€¿200
  radius â† 50
  intersect â† âˆâ€¿âˆ
  # Main game loop
  {ğ•¤
    angleDelta â† rf.GetFrameTimeâŠ¸Ã—-Â´rf.IsKeyDownÂ¨key.rightâ€¿key.left
    direction â†© rm.Vector2Transform directionâ‹ˆrm.MatrixRotateZ 0.5Ã—angleDeltaÃ—Ï€

    touchedRecâ€¿touchedCir â† {
      intersect â†© âŒŠÂ´ğ•©
      âˆâ€¿âˆâŠ¸â‰¢Â¨ğ•©
    } âŸ¨
      RayIntersectRect boxâ€¿originâ€¿direction
      CheckCollisionRay2dCircle originâ€¿directionâ€¿centerâ€¿radius
    âŸ©
    box rl.draw.RectangleËœ color.redâŸtouchedRec color.gray
    rf.DrawCircleV originâ€¿10â€¿color.yellow

    rf.DrawCircleVÂ¨touchedCirâŠ‘âŸ¨
      âŸ¨centerâ€¿radiusâ€¿color.grayâŸ©
      âŸ¨
        centerâ€¿radiusâ€¿color.red
        intersectâ€¿5â€¿color.green
      âŸ©
    âŸ©
    rf.DrawLineVâŸ¨origin, origin+directionÃ—500, color.blueâŸ©
    rf.DrawCircleV intersectâ€¿5â€¿color.green
  } draw._withCanvas_ color.black â€¢_while_ (Â¬rl.window.ShouldClose)@
} rl.window._openAs "raylib extras [Math2d] example - ray rect intersection"