r â† â€¢Import "../../rayed.bqn"

# Initialization
#--------------------------------------------------------------------------------------

# VR device parameters definition
device â† âŸ¨
    # Oculus Rift CV1 parameters for simulator
    2160     # Horizontal resolution in pixels
    1200     # Vertical resolution in pixels
    0.133793 # Horizontal size in meters
    0.0669   # Vertical size in meters
    0.041    # Distance between eye and display in meters
    0.07     # Lens separation distance in meters
    0.07     # IPD (distance between pupils) in meters

    # NOTE: CV1 uses fresnel-hybrid-asymmetric lenses with specific compute shaders
    # Following parameters are just an approximation to CV1 distortion stereo rendering
    1â€¿0.22â€¿0.24â€¿0          # Lens distortion
    0.996â€¿Â¯0.004â€¿1.014â€¿0   # Chromatic aberration correction
âŸ©
deviceIndex â† {
  hResolution            â‡ 0 # Horizontal resolution in pixels
  vResolution            â‡ 1 # Vertical resolution in pixels
  hScreenSize            â‡ 2 # Horizontal size in meters
  vScreenSize            â‡ 3 # Vertical size in meters
  eyeToScreenDistance    â‡ 4 # Distance between eye and display in meters
  lensSeparationDistance â‡ 5 # Lens separation distance in meters
  interpupillaryDistance â‡ 6 # IPD (distance between pupils) in meters
  lensDistortionValues   â‡ 7 # Lens distortion constant parameters
  chromaAbCorrection     â‡ 8 # Chromatic aberration correction parameters
}

# Load VR stereo config for VR device parameteres (Oculus Rift CV1 parameters)
config â† r.raylib.LoadVrStereoConfig device
configIndex â† {
  projection        â‡ 0 # VR projection matrices (per eye)
  viewOffset        â‡ 1 # VR view offset matrices (per eye)
  leftLensCenter    â‡ 2 # VR left lens center
  rightLensCenter   â‡ 3 # VR right lens center
  leftScreenCenter  â‡ 4 # VR left screen center
  rightScreenCenter â‡ 5 # VR right screen center
  scale             â‡ 6 # VR distortion scale
  scaleIn           â‡ 7 # VR distortion scale in
}

renderTextureIndex â† {
  id      â‡ 0 # OpenGL framebuffer object id
  texture â‡ 1 # Color buffer attachment texture
  depth   â‡ 2 # Depth buffer attachment texture
}

textureIndex â† {
  id      â‡ 0 # OpenGL texture id
  width   â‡ 1 # Texture base width
  height  â‡ 2 # Texture base height
  mipmaps â‡ 3 # Mipmap levels, 1 by default
  format  â‡ 4 # Data format (PixelFormat type)
}


ArrAlloc â† {
  p â† (r.raylib.MemAlloc 4Ã—â‰ ğ•©).Cast "f32"
  (â†•â‰ ğ•©) p.WriteÂ¨ğ•©
  p
}

# NOTE: screenWidth/screenHeight should match VR device aspect ratio
r.window.SetSize 800â€¿450

{ğ•Š:

  # Distortion shader (uses device lens distortion and chroma)
  d â† r.raylib.LoadShader â€¢file.RealPathÂ¨ "default.vs"â€¿"distortion330.fs"

  âŸ¨v4â‡shader_uniform_vec4
  â‹„v2â‡shader_uniform_vec2âŸ©â† r.raylib.shaderUniformDataType

  # Update distortion shader with lens and distortion-scale parameters
  r.raylib.SetShaderValueÂ¨r.raylib.GetShaderLocationâŒ¾(1âŠ¸âŠ‘)Â¨âˆ¾âŸ¨
    {âŸ¨dâ‹„dâ€¿ğ•¨â‹„ArrAllocğ•©âŠ‘configâ‹„v2âŸ©}Â´Â¨âŸ¨
      "leftLensCenter"   â€¿configIndex.leftLensCenter
      "rightLensCenter"  â€¿configIndex.rightLensCenter
      "leftScreenCenter" â€¿configIndex.leftScreenCenter
      "rightScreenCenter"â€¿configIndex.rightScreenCenter
      "scale"            â€¿configIndex.scale
      "scaleIn"          â€¿configIndex.scaleIn
    âŸ©
    {âŸ¨dâ‹„dâ€¿ğ•¨â‹„ArrAllocğ•©âŠ‘deviceâ‹„v4âŸ©}Â´Â¨âŸ¨
      "deviceWarpParam"â€¿deviceIndex.lensDistortionValues
      "chromaAbParam"  â€¿deviceIndex.chromaAbCorrection
    âŸ©
  âŸ©
  # Initialize framebuffer for stereo rendering
  # NOTE: Screen size should match HMD aspect ratio
  target â† r.raylib.LoadRenderTexture deviceâŠËœ{ğ•©.hResolutionâ€¿ğ•©.vResolution}deviceIndex

  # Define the camera to look into our 3d world
  camera â† âŸ¨
    5â€¿2â€¿5              # Camera position
    0â€¿2â€¿0              # Camera looking at point
    0â€¿1â€¿0              # Camera up vector
    60                 # Camera field-of-view Y
    r.raylib.cameraProjection.camera_perspective # Camera projection type
  âŸ©
  cubePosition â† 0â€¿0â€¿0

  r.raylib.DisableCursorâŸ¨âŸ© # Limit cursor to relative movement inside the window

  # Main game loop
  # Detect window close button or ESC key
  {ğ•Š
      # Update
      #----------------------------------------------------------------------------------
      âŸ¨âŸ¨cameraâŸ©âŸ© â†© r.raylib.UpdateCameraRefâŸ¨â‹ˆcamera, r.raylib.cameraMode.cameraFirstPersonâŸ©
      #----------------------------------------------------------------------------------

      # Draw
      #----------------------------------------------------------------------------------
      r.raylib.BeginTextureMode target
        r.raylib.ClearBackground r.color.raywhite
        r.raylib.BeginVrStereoMode config
          r.raylib.BeginMode3D camera
            r.raylib.DrawCube cubePositionâ€¿2â€¿2â€¿2â€¿r.color.red
            r.raylib.DrawCubeWires cubePositionâ€¿2â€¿2â€¿2â€¿r.color.maroon
            r.raylib.DrawGrid 40â€¿1
          r.raylib.EndMode3DâŸ¨âŸ©
        r.raylib.EndVrStereoModeâŸ¨âŸ©
      r.raylib.EndTextureModeâŸ¨âŸ©

      r.raylib.BeginDrawingâŸ¨âŸ©
        r.raylib.ClearBackground r.color.raywhite
        r.raylib.BeginShaderMode d
          r.raylib.DrawTextureProâŸ¨
            renderTextureIndex.textureâŠ‘ target
            0â€¿0âˆ¾ â‹ˆâŸœ-Â´ textureIndex.widthâ€¿textureIndex.heightâŠ renderTextureIndex.textureâŠ‘ target # source
            0â€¿0âˆ¾r.window.GetSize@ # dest
            0â€¿0, 0, r.color.white
          âŸ©
        r.raylib.EndShaderModeâŸ¨âŸ©
        r.raylib.DrawFPS 10â€¿10
      r.raylib.EndDrawingâŸ¨âŸ©
      #----------------------------------------------------------------------------------
  } â€¢_while_ (Â¬r.window.ShouldClose)@

  # De-Initialization
  #--------------------------------------------------------------------------------------
  r.raylib.UnloadVrStereoConfig config   # Unload stereo config

  r.raylib.UnloadRenderTexture target    # Unload stereo render fbo
  r.raylib.UnloadShader d       # Unload distortion shader
} r.window._openAs "raylib [core] example - vr simulator"
