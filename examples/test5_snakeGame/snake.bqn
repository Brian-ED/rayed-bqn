# My highscore is 83... beat that!

âŸ¨câ‡color,window,draw,kâ‡keyâŸ©â†râ†â€¢Import "../../raylib.bqn"
textSize â† 100
size â† 15

GetConsts â† {ğ•Š:{
  winSize       â‡ window.GetSize@
  textPixelSize â‡ r.rayFFI.MeasureTextÂ¨textSizeâ‹ˆËœÂ¨"Paused"â€¿"GAME OVER"
  tileSize      â‡ âŒŠwinSizeâŒŠÂ´âŠ¸Ã·size+2
  lines         â‡ âŒ½Â¨âŠ¸âˆ¾(âŠ¢âˆ¾âŒœ2â†‘1âŒ½â¼âŠ¢)tileSizeÃ—1+â†•1+size # Line drawing positions
}}

nonDarkModeâ€¿darkMode â† {
  âŸ¨text, fruit, snake, lines, backgroundâŸ© â‡ ğ•©
}Â¨{
  yellow â† 255â€¿200â€¿0â€¿255
  âŸ¨c.blackâ€¿c.redâ€¿c.blue â€¿c.whiteâ€¿yellow
   âŒˆc.whiteâ€¿c.redâ€¿c.greenâ€¿c.whiteâ€¿c.blackÃ·1.3âŸ© # divided to lower intencity
}

OnStart â† {ğ•¤
  frame â† 0 â‹„ speed â† 10
  # 0 is gameOver, 1 is playing, 2 is paused
  gameState â† 1
  # List of xâ€¿y positions of the snake
  snake â† [0â€¿0]
  fruit â† 2 â€¢rand.Range size
  # 0â€¿1 up, 1â€¿0 right, 0â€¿Â¯1 down, Â¯1â€¿0 left
  # first in list is the current facing, pressing right 1âŒ½ pressing left 1âŒ½â¼
  facing â† [1â€¿0, 0â€¿Â¯1, Â¯1â€¿0, 0â€¿1]
  # buffer for key presses
  buffer â† âŸ¨âŸ©
  palete â† nonDarkMode
  gameStateâ€¿frameâ€¿snakeâ€¿fruitâ€¿facingâ€¿speedâ€¿bufferâ€¿palete
}
PerGameFrame â† {ğ•ŠgameStateâ€¿snakeâ€¿fruitâ€¿facingâ€¿buffer:
  SpawnFruit      â† {â€¢rand.Rangeâˆ˜â‰ âŠ¸âŠ‘(<Ë˜ğ•¨)(Â¬âˆ˜âˆŠËœ/âŠ¢)â¥Šâ†•2â¥Šsize}
  nowFacing       â† facingâŒ½Ëœ-Â´k.kLeftâ€¿k.kRight=âŠ‘1â†‘buffer
  extendedSnake   â† nowfacing(âŠ¢âˆ¾Ëœsize|+â—‹âŠ)snake
  newFruit        â† extendedSnake SpawnFruitâŸ(âŠâŠ¸â‰¡) fruit
  cutSnake        â† Â¯1âŠ¸â†“âŸ(newFruitâ‰¡fruit)extendedSnake
  âŸ¨
    gameStateÃ—â·âŠ¸â‰¡cutSnake # gameState
    cutSnake              # snake
    newFruit              # fruit
    nowFacing             # facing 
    1â†“2â†‘buffer            # reset buffer
  âŸ©
}âŒ¾(0â€¿2â€¿3â€¿4â€¿6âŠ¸âŠ)
PerFrame â†{conğ•ŠâŸ¨gameState,frame,snake,fruit,facing,speed,buffer,palâŸ©:
  pauseP â† k.kRIGHT_SHIFT = key â† k.GetPressed@
  10â€¿10 c.black draw._Text_ 40 Ëœâ€¢Repr Â¯1+â‰ snake
  âŠ‘â—¶âŸ¨ # each function is one scene
    {
      "GAME OVER"pal.text draw._Text_ textSize 2â¥Š2Ã·Ëœcon.winSize-1âŠ‘con.textPixelSize
      palâŒ¾(7âŠ‘âŠ¢)OnStartâŸpauseP ğ•© # nums mean values to reset
    }
    PerGameFrameâŸ(1=speed|frame) {ğ•¤
      c.white draw._LineË˜con.lines
      ( con.tileSize-2) pal.fruit draw._Rectangleâ—‹(2âŠ¸â¥Š)    1+con.tileSizeÃ—1+fruit
      {(con.tileSize-2) pal.snake draw._Rectangleâ—‹(2âŠ¸â¥Š) ğ•©}Ë˜1+con.tileSizeÃ—1+snake
      âŸ¨frame+1
       2âŒˆspeed+-Â´key=k.kDOWNâ€¿k.kUP        # speed
       keyâˆ¾âŸ(âŠ‘âˆŠâŸœk.kLeftâ€¿k.kRight) bufferâŸ© # Key buffer
    }âŒ¾(1â€¿5â€¿6âŠ¸âŠ)
    {
      pauseTextâ†"Paused"âˆ¾(@+10)âˆ¾"d for dark"
      pauseText pal.text draw._Text_ textSize 2Ã·Ëœcon.winSize-con.textPixelSizeâŠ‘âŠ¸âˆ¾textSize
      {ğ•©â‰¡nonDarkMode?darkMode;nonDarkMode}âŒ¾(7âŠ‘âŠ¢)âŸ(key=k.kD)ğ•©
    }
  âŸ©  {1:2;2:1;ğ•©}âŸpausePâŒ¾âŠ‘ ğ•©
} draw._withCanvas_ {(7âŠ‘ğ•©).background}

Game â† GetConsts PerFrameâ€¢_While_(Â¬window.ShouldClose) OnStart
Game window._openAs_ "Snake" 1